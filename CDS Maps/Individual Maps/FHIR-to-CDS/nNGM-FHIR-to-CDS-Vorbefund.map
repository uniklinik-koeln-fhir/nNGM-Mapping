/// version = 0.1
/// title = "nNGM_Mapping_VorbefundCTS"

/* 
    TODO
    - "Sonstige Fusion NGS" Observation: if there is only 1 "Fusionspartner" given, it gets mapped to the "Erster Fusionspartner" (id_2255) even if it was entered 
        in the "Zweiter Fusionspartner" field. This behaviour is because both components for the Fusionspartner are using the same code (48018-6)
*/

map "http://uk-koeln.de/fhir/StructureMap/nNGM_Mapping_VorbefundCDS" = nNGM_Mapping_VorbefundCDS

uses "http://hl7.org/fhir/StructureDefinition/Bundle" as source
uses "http://hl7.org/fhir/StructureDefinition/CTS_Transport" as target

group TransformVorbefundCDS(source entry: BackboneElement, target tgt: BackboneElement, target index: RepeatIndex)
{
    entry.resource as specimen where "resource is Specimen and resource.meta.profile = 'http://uk-koeln.de/fhir/StructureDefinition/Specimen/nNGM'" 
        then TransformVBSpecimenCDS(specimen, tgt);

    entry.resource as diagnosticReport where "resource is DiagnosticReport and resource.meta.profile = 'http://uk-koeln.de/fhir/StructureDefinition/DiagnosticReport/nNGM/befund'" 
        then TransformVBDiagnosticReportCDS(diagnosticReport, tgt);

    // Histologie
    entry.resource as observationHL where "resource is Observation and resource.meta.profile = 'http://uk-koeln.de/fhir/StructureDefinition/Observation/nngm/histologie'" 
        then TransformVBObservationHistologieCDS(observationHL, tgt);

    // Immunhistochemie
    entry.resource as observationIHC where "resource is Observation and resource.meta.profile = 'http://uk-koeln.de/fhir/StructureDefinition/Observation/ihc'"
        then TransformVBObservationIHCCDS(observationIHC, tgt);

    // Molekularpathologie
    entry.resource as observation where "resource is Observation and resource.meta.profile = 'http://uk-koeln.de/fhir/StructureDefinition/Observation/ish'"
        then TransformVBCISHObservationMPCDS(observation, tgt);

    entry.resource as observation where "resource is Observation and resource.meta.profile = 'http://uk-koeln.de/fhir/StructureDefinition/Observation/fish'"
        then TransformVBFISHObservationMPCDS(observation, tgt);

    // Fusion NGS - evaluates index.caseIndex as repeatindex
    entry.resource as observation where "resource is Observation and resource.meta.profile = 'http://uk-koeln.de/fhir/StructureDefinition/Observation/ngs-fusion-expression'"
        then TransformVBObservationFSCDS(observation, tgt, index);

    // Fast Track 
    entry.resource as observation where "resource is Observation and resource.meta.profile = 'http://uk-koeln.de/fhir/StructureDefinition/Observation/fasttrack'"
        then TransformVBObservationFTCDS(observation, tgt);

    // NGS Panel - evaluates index.sectionIndex as repeatindex
    entry.resource as observation where "resource is Observation and resource.meta.profile = 'http://uk-koeln.de/fhir/StructureDefinition/Observation/ngs-panel'" 
        then TransformVBObservationLPCDS(observation, tgt, index);

    // NGS Panel Device  
    entry.resource as device where "resource is Device and resource.meta.profile = 'http://uk-koeln.de/fhir/StructureDefinition/Device/nNGM/ngs-panel'" 
        then TransformVBDeviceLPCDS(device, tgt);
}

/* ------------------------------ Specimen ---------------------------- */
group TransformVBSpecimenCDS(source specimen: Specimen, target tgt: BackboneElement)
{
    //Eingang des Tumormaterials am nNGM-Standort -> 0, 0, id_2471
    specimen -> tgt.data as data then
    {
        specimen.receivedTime as rt then
        {   
            specimen -> data.blockindex  = 0;
            specimen -> data.groupindex  = 0;
            specimen -> data.itemid      = 'id_2471';
            rt -> data.values as values, values.value = rt;
        };
    };  
}

/* -------------------------- DiagnosticReport ------------------------ */
group TransformVBDiagnosticReportCDS(source diagnosticReport: DiagnosticReport, target tgt: BackboneElement)
{
    //Befunddatum -> 0, 0, id_1653
    diagnosticReport -> tgt.data as data then
    {
        diagnosticReport.effectiveDateTime as edt then
        {   
            diagnosticReport -> data.blockindex  = 0;
            diagnosticReport -> data.groupindex  = 0;
            diagnosticReport -> data.itemid      = 'id_1653';
            edt -> data.values as values, values.value = edt;
        };
    };                
    //Befundnummer -> 0, 0, id_1654
    diagnosticReport -> tgt.data as data then
    {
        diagnosticReport.identifier as identifier,
            identifier.system as system where "system = 'http://uk-koeln.de/NamingSystem/nNGM/befundnummer'" then
        {   
            diagnosticReport -> data.blockindex  = 0;
            diagnosticReport -> data.groupindex  = 0;
            diagnosticReport -> data.itemid      = 'id_1654';
            identifier.value as value-> data.values as values, values.value = value;
        };
    };                
}

/* ---------------------- ObservationHistologie ----------------------- */
group TransformVBObservationHistologieCDS(source observation: Observation, target tgt: BackboneElement)
{
    //Klassifikation -> klassifikation component -> 1, 0,  id_1658
    observation -> tgt.data as data then
    {
        observation.component as component, component.code where "code.coding.code = 'C25161'" then
        {
            component.valueCodeableConcept as valueCodeableConcept,
            valueCodeableConcept.coding as coding, coding.code as code then 
            {
                observation -> data.blockindex  = 1;
                observation -> data.groupindex  = 0;
                observation -> data.itemid      = 'id_1658';
                code -> data.values as values, values.value = code;
            };
        };
    };

    //Lokalisation -> 1, 0, id_2469
    observation -> tgt.data as data then
    {
        observation.bodySite as bodySite where "$this.bodySite.coding.system = 'urn:oid:2.16.840.1.113883.6.43.1'", 
        bodySite.coding as coding then
        {   
            observation -> data.blockindex = 1;
            observation -> data.groupindex = 0;
            observation -> data.itemid     = 'id_2469';
            coding.code as code -> data.values as values, values.value = code;
        };
    };

    //Grading -> 1, 0, id_2403
    observation -> tgt.data as data then
    {
        observation.valueCodeableConcept as cc, cc.coding as coding then
        {   
            observation -> data.blockindex = 1;
            observation -> data.groupindex = 0;
            observation -> data.itemid     = 'id_2403';
            coding.code as code -> data.values as values, values.value = code;
        };
    };
}

/*---------------------------------------------------------------------
                            Immunhistochemie (IHC)                         
----------------------------------------------------------------------- */
group TransformVBObservationIHCCDS(source observation: Observation, target tgt: BackboneElement)
{
    observation where "code.coding.code = 'BRAF'" then TransformVBIHCObservationBRAFCDS(observation, tgt);
    observation where "code.coding.code = 'CK7'" then TransformVBIHCObservationCK7CDS(observation, tgt);
    observation where "code.coding.code = 'MIB1'" then TransformVBIHCObservationMIB1CDS(observation, tgt);
    observation where "code.coding.code = 'Napsin A'" then TransformVBIHCObservationNapsinACDS(observation, tgt);
    observation where "code.coding.code = 'P40'" then TransformVBIHCObservationP40CDS(observation, tgt);
    observation where "code.coding.code = 'Synaptophysin'" then TransformVBIHCObservationSynaptophysinCDS(observation, tgt);
    observation where "code.coding.code = 'TTF1'" then TransformVBIHCObservationTTF1CDS(observation, tgt);
    observation where "code.coding.code = 'ALK'" then TransformVBIHCObservationALKCDS(observation, tgt);
    observation where "code.coding.code = 'MET'" then TransformVBIHCObservationMETCDS(observation, tgt);
    observation where "code.coding.code = 'PD-L1'" then TransformVBIHCObservationPDL1CDS(observation, tgt);
    observation where "code.coding.code = 'ROS1'" then TransformVBIHCObservationROS1CDS(observation, tgt);
}

/* ---------------------- Observation BRAF IHC ------------------------ */
group TransformVBIHCObservationBRAFCDS(source observation: Observation, target tgt: BackboneElement)
{
    //Date Of Assesment -> 4, 0, braf_ihc_group
    observation.effectiveDateTime as dateOfAssessment -> tgt.data as data then
    {
        observation -> data.blockindex = 4;
        observation -> data.groupindex = 0;
        observation -> data.itemid     = 'braf_ihc_group';
        dateOfAssessment -> data.values as values, values.value = dateOfAssessment;
    };
    //Phänotyp: phanotyp component-> 4, 0, braf_ihc_phaenotype
    observation -> tgt.data as data then
    {
        observation.component as component, component.code where "code.coding.code = 'C16977'" then
        {
            component.valueCodeableConcept as vcc then
            {
                observation -> data.blockindex = 4;
                observation -> data.groupindex = 0;
                observation -> data.itemid     = 'braf_ihc_phaenotype';
                vcc.coding as coding where "coding.code = 'C80488'"->data.values as values, values.unit = 'predef', values.value = 'Expression';
                vcc.coding as coding where "coding.code = 'C28510'"->data.values as values, values.unit = 'predef', values.value = 'Fusion';
                vcc.coding as coding where "coding.code = 'C25418'"->data.values as values, values.unit = 'predef', values.value = 'Amplifikation';
            };
        };
    };

    //Ergebnis -> 4, 0, braf_ihc_result
    observation->tgt.data as data then
    {
        observation.valueCodeableConcept as valueCodeableConcept,
            valueCodeableConcept.coding as coding,
            coding.code as code then
        {
            observation->data.blockindex = 4;
            observation->data.groupindex = 0;
            observation->data.itemid = 'braf_ihc_result';
            code->data.values as values, values.value = code;
        };
    };
}

/* ---------------------- Observation CK7 IHC ------------------------ */
group TransformVBIHCObservationCK7CDS(source observation: Observation, target tgt: BackboneElement)
{
    //Date Of Assesment -> 5, 0, id_2037
    observation-> tgt.data as data then
    {
        observation.effectiveDateTime as dateOfAssessment then
        {
            observation -> data.blockindex = 5;
            observation -> data.groupindex = 0;
            observation -> data.itemid     = 'id_2037';
            dateOfAssessment-> data.values as values, values.value = dateOfAssessment;
        };
    };

    //Phänotyp: phanotyp component-> 5, 0, id_2038
    observation -> tgt.data as data then
    {
        observation.component as component, component.code where "code.coding.code = 'C16977'" then
        {
            component.valueCodeableConcept as vcc then
            {
                observation -> data.blockindex = 5;
                observation -> data.groupindex = 0;
                observation -> data.itemid     = 'id_2038';
                vcc.coding as coding where "coding.code = 'C80488'"->data.values as values, values.unit = 'predef', values.value = 'Expression';
                vcc.coding as coding where "coding.code = 'C28510'"->data.values as values, values.unit = 'predef', values.value = 'Fusion';
                vcc.coding as coding where "coding.code = 'C25418'"->data.values as values, values.unit = 'predef', values.value = 'Amplifikation';
            };
        };
    };

    //Ergebnis -> 5, 0, id_2045
    observation->tgt.data as data then
    {
        observation.valueCodeableConcept as valueCodeableConcept,
            valueCodeableConcept.coding as coding,
            coding.code as code then
        {
            observation->data.blockindex = 5;
            observation->data.groupindex = 0;
            observation->data.itemid = 'id_2045';
            code->data.values as values, values.value = code;
        };
    };
}

/* --------------------- Observation MIB1 IHC ------------------------ */
group TransformVBIHCObservationMIB1CDS(source observation: Observation, target tgt: BackboneElement)
{
    //Date Of Assesment -> 7, 0, id_2055
    observation-> tgt.data as data then
    {
        observation.effectiveDateTime as dateOfAssessment then
        {
            observation->data.blockindex = 7;
            observation->data.groupindex = 0;
            observation->data.itemid     = 'id_2055';
            dateOfAssessment-> data.values as values, values.value = dateOfAssessment;
        };
    };

    //Phänotyp: phanotyp component-> 7, 0, id_2056
    observation -> tgt.data as data then
    {
        observation.component as component, component.code where "code.coding.code = 'C16977'" then
        {
            component.valueCodeableConcept as vcc then
            {
                observation -> data.blockindex = 7;
                observation -> data.groupindex = 0;
                observation -> data.itemid     = 'id_2056';
                vcc.coding as coding where "coding.code = 'C80488'"->data.values as values, values.unit = 'predef', values.value = 'Expression';
                vcc.coding as coding where "coding.code = 'C28510'"->data.values as values, values.unit = 'predef', values.value = 'Fusion';
                vcc.coding as coding where "coding.code = 'C25418'"->data.values as values, values.unit = 'predef', values.value = 'Amplifikation';
            };
        };
    };

    //Ergebnis -> 7, 0, id_2063
    observation->tgt.data as data then
    {
        observation.valueCodeableConcept as valueCodeableConcept,
            valueCodeableConcept.coding as coding,
            coding.code as code then
        {
            observation->data.blockindex = 7;
            observation->data.groupindex = 0;
            observation->data.itemid = 'id_2063';
            code->data.values as values, values.value = code;
        };
    };
}

/* ------------------ Observation Napsin A IHC ----------------------- */
group TransformVBIHCObservationNapsinACDS(source observation: Observation, target tgt: BackboneElement)
{
    //Date Of Assesment -> 14, 0, id_2064
    observation-> tgt.data as data then
    {
        observation.effectiveDateTime as dateOfAssessment then
        {
            observation -> data.blockindex   = 14;
            observation -> data.groupindex   = 0;
            observation -> data.itemid       = 'id_2064';
            dateOfAssessment-> data.values as values, values.value = dateOfAssessment;
        };
    };

    //Phänotyp: phanotyp component-> 14, 0, id_2065
    observation -> tgt.data as data then
    {
        observation.component as component, component.code where "code.coding.code = 'C16977'" then
        {
            component.valueCodeableConcept as vcc then
            {
                observation -> data.blockindex = 14;
                observation -> data.groupindex = 0;
                observation -> data.itemid     = 'id_2065';
                vcc.coding as coding where "coding.code = 'C80488'"->data.values as values, values.unit = 'predef', values.value = 'Expression';
                vcc.coding as coding where "coding.code = 'C28510'"->data.values as values, values.unit = 'predef', values.value = 'Fusion';
                vcc.coding as coding where "coding.code = 'C25418'"->data.values as values, values.unit = 'predef', values.value = 'Amplifikation';
            };
        };
    };

    //Ergebnis -> 14, 0, id_2072
    observation->tgt.data as data then
    {
        observation.valueCodeableConcept as valueCodeableConcept,
            valueCodeableConcept.coding as coding,
            coding.code as code then
        {
            observation->data.blockindex = 14;
            observation->data.groupindex = 0;
            observation->data.itemid = 'id_2072';
            code->data.values as values, values.value = code;
        };
    };
}

/* ---------------------- Observation P40 IHC ------------------------ */
group TransformVBIHCObservationP40CDS(source observation: Observation, target tgt: BackboneElement)
{
    //Date Of Assesment -> 15, 0, id_2073
    observation-> tgt.data as data then
    {
        observation.effectiveDateTime as dateOfAssessment then
        {
            observation -> data.blockindex   = 15;
            observation -> data.groupindex   = 0;
            observation -> data.itemid       = 'id_2073';
            dateOfAssessment-> data.values as values, values.value = dateOfAssessment;
        };
    };

    //Phänotyp: phanotyp component-> 15, 0, id_2074
    observation -> tgt.data as data then
    {
        observation.component as component, component.code where "code.coding.code = 'C16977'" then
        {
            component.valueCodeableConcept as vcc then
            {
                observation -> data.blockindex = 15;
                observation -> data.groupindex = 0;
                observation -> data.itemid     = 'id_2074';
                vcc.coding as coding where "coding.code = 'C80488'"->data.values as values, values.unit = 'predef', values.value = 'Expression';
                vcc.coding as coding where "coding.code = 'C28510'"->data.values as values, values.unit = 'predef', values.value = 'Fusion';
                vcc.coding as coding where "coding.code = 'C25418'"->data.values as values, values.unit = 'predef', values.value = 'Amplifikation';
            };
        };
    };

    //Ergebnis -> 15, 0, id_2079
    observation->tgt.data as data then
    {
        observation.valueCodeableConcept as valueCodeableConcept,
            valueCodeableConcept.coding as coding,
            coding.code as code then
        {
            observation->data.blockindex = 15;
            observation->data.groupindex = 0;
            observation->data.itemid = 'id_2079';
            code->data.values as values, values.value = code;
        };
    };
}

/* ----------------- Observation Synaptophysin IHC -------------------- */
group TransformVBIHCObservationSynaptophysinCDS(source observation: Observation, target tgt: BackboneElement)
{
    //Date Of Assesment -> 18, 0, id_2080
    observation-> tgt.data as data then
    {
        observation.effectiveDateTime as dateOfAssessment then
        {
            observation -> data.blockindex = 18;
            observation -> data.groupindex = 0;
            observation -> data.itemid     = 'id_2080';
            dateOfAssessment-> data.values as values, values.value = dateOfAssessment;
        };
    };

    //Phänotyp: phanotyp component-> 18, 0, id_2081
    observation -> tgt.data as data then
    {
        observation.component as component, component.code where "code.coding.code = 'C16977'" then
        {
            component.valueCodeableConcept as vcc then
            {
                observation -> data.blockindex = 18;
                observation -> data.groupindex = 0;
                observation -> data.itemid     = 'id_2081';
                vcc.coding as coding where "coding.code = 'C80488'"->data.values as values, values.unit = 'predef', values.value = 'Expression';
                vcc.coding as coding where "coding.code = 'C28510'"->data.values as values, values.unit = 'predef', values.value = 'Fusion';
                vcc.coding as coding where "coding.code = 'C25418'"->data.values as values, values.unit = 'predef', values.value = 'Amplifikation';
            };
        };
    };

    //Ergebnis -> 18, 0, id_2088
    observation->tgt.data as data then
    {
        observation.valueCodeableConcept as valueCodeableConcept,
            valueCodeableConcept.coding as coding,
            coding.code as code then
        {
            observation->data.blockindex = 18;
            observation->data.groupindex = 0;
            observation->data.itemid = 'id_2088';
            code->data.values as values, values.value = code;
        };
    };
}

/* --------------------- Observation TTF1 IHC ------------------------- */
group TransformVBIHCObservationTTF1CDS(source observation: Observation, target tgt: BackboneElement)
{
    //Date Of Assesment -> 19, 0, id_2089
    observation-> tgt.data as data then
    {
        observation.effectiveDateTime as dateOfAssessment then
        {
            observation -> data.blockindex   = 19;
            observation -> data.groupindex   = 0;
            observation -> data.itemid       = 'id_2089';
            dateOfAssessment-> data.values as values, values.value = dateOfAssessment;
        };
    };
    //Phänotyp: phanotyp component-> 19, 0, id_2090
    observation -> tgt.data as data then
    {
        observation.component as component, component.code where "code.coding.code = 'C16977'" then
        {
            component.valueCodeableConcept as vcc then
            {
                observation -> data.blockindex = 19;
                observation -> data.groupindex = 0;
                observation -> data.itemid     = 'id_2090';
                vcc.coding as coding where "coding.code = 'C80488'"->data.values as values, values.unit = 'predef', values.value = 'Expression';
                vcc.coding as coding where "coding.code = 'C28510'"->data.values as values, values.unit = 'predef', values.value = 'Fusion';
                vcc.coding as coding where "coding.code = 'C25418'"->data.values as values, values.unit = 'predef', values.value = 'Amplifikation';
            };
        };
    };

    //Ergebnis -> 19, 0, id_2097
    observation->tgt.data as data then
    {
        observation.valueCodeableConcept as valueCodeableConcept,
            valueCodeableConcept.coding as coding,
            coding.code as code then
        {
            observation->data.blockindex = 19;
            observation->data.groupindex = 0;
            observation->data.itemid = 'id_2097';
            code->data.values as values, values.value = code;
        };
    };
}

/* --------------------- Observation ALK IHC -------------------------- */
group TransformVBIHCObservationALKCDS(source observation: Observation, target tgt: BackboneElement)
{
    //Date of Assessment -> 3, 0,id_2098
    //Phaenotyp -> 3, 0, id_2099 
    //these two items shown before were mapped in the following group
    observation then TransformationObservationALKDatePhanotypVorbefund(observation, tgt);
    
    //Ergebnis -> 3, 0, id_2106
    observation->tgt.data as data then
    {
        observation.valueCodeableConcept as valueCodeableConcept,
            valueCodeableConcept.coding as coding,
            coding.code as code then
        {
            observation->data.blockindex = 3;
            observation->data.groupindex = 0;
            observation->data.itemid = 'id_2106';
            code->data.values as values, values.value = code;
        };
    };
}

/* --------------------- Observation MET IHC -------------------------- */
group TransformVBIHCObservationMETCDS(source observation: Observation, target tgt: BackboneElement)
{
    //Date of Assessment -> 6, 0,id_2132
    //Phaenotyp -> 6, 0, id_2133
    //these two items shown before were mapped in the following group
    observation then TransformationObservationMETDatePhanotypVorbefund(observation, tgt);

    //Ergebnis -> 6, 0, id_2139
    observation->tgt.data as data then
    {
        observation.valueCodeableConcept as valueCodeableConcept,
            valueCodeableConcept.coding as coding,
            coding.code as code then
        {
            observation->data.blockindex = 6;
            observation->data.groupindex = 0;
            observation->data.itemid = 'id_2139';
            code->data.values as values, values.value = code;
        };
    };

    //Klassifikation -> Klassifikation component -> 6, 0, id_2140
    observation -> tgt.data as data then
    {
        observation.component as component,
        component.code where "code.coding.code = 'C25161'" then
        {
            component.valueCodeableConcept as valueCodeableConcept,
            valueCodeableConcept.coding as coding,
            coding.code as code then 
            {
                observation -> data.blockindex = 6;
                observation -> data.groupindex = 0;
                observation -> data.itemid     = 'id_2140';
                code -> data.values as values, values.value = code;
            };
        };
    };

    //Expression high-level -> expression-high-level component -> 6, 0, id_2141
    observation -> tgt.data as data then
    {
        observation.component as component,
        component.code where "code.coding.code = 'C129474'" then
        {
            observation  -> data.blockindex = 6;
            observation  -> data.groupindex = 0;
            observation  -> data.itemid     = 'id_2141';
            component.valueBoolean as valueBoolean where "valueBoolean = false" -> data.values as values, values.value = 'no';
            component.valueBoolean as valueBoolean where "valueBoolean = true" -> data.values as values, values.value = 'yes';
        };
    };
}

/* --------------------- Observation PD-L1 IHC ------------------------- */
group TransformVBIHCObservationPDL1CDS(source observation: Observation, target tgt: BackboneElement)
{
    //Date Of Assesment -> 16, 0, id_2172
    observation-> tgt.data as data then
    {
        observation.effectiveDateTime as dateOfAssessment then
        {
            observation -> data.blockindex = 16;
            observation -> data.groupindex = 0;
            observation -> data.itemid     = 'id_2172';
            dateOfAssessment-> data.values as values, values.value = dateOfAssessment;
        };
    };

    //Phänotyp: phanotyp component-> 16, 0, id_2173
    observation -> tgt.data as data then
    {
        observation.component as component, component.code where "code.coding.code = 'C16977'" then
        {
            component.valueCodeableConcept as vcc then
            {
                observation -> data.blockindex = 16;
                observation -> data.groupindex = 0;
                observation -> data.itemid     = 'id_2173';
                vcc.coding as coding where "coding.code = 'C80488'"->data.values as values, values.unit = 'predef', values.value = 'Expression';
                vcc.coding as coding where "coding.code = 'C28510'"->data.values as values, values.unit = 'predef', values.value = 'Fusion';
                vcc.coding as coding where "coding.code = 'C25418'"->data.values as values, values.unit = 'predef', values.value = 'Amplifikation';
            };
        };
    };

    //Ergebnis -> 16, 0, id_2180
    observation->tgt.data as data then
    {
        observation.valueCodeableConcept as valueCodeableConcept,
            valueCodeableConcept.coding as coding,
            coding.code as code then
        {
            observation->data.blockindex = 16;
            observation->data.groupindex = 0;
            observation->data.itemid = 'id_2180';
            code->data.values as values, values.value = code;
        };
    };

    //Menge der Tumorzellen (% positive Tumorzellen TPS) -> menge-tumorzellen component -> 16, 0, id_2181
    observation -> tgt.data as data then
    {
        observation.component as component then
        {
            component.valueQuantity as quantity where "code.coding.code = 'C127771'" then
            {
                observation->data.blockindex = 16;
                observation->data.groupindex = 0;
                observation->data.itemid     = 'id_2181';
                quantity.value as value ->data.values as values, 
                                values.unit  = 'percent', 
                                values.value = value;
            };
        };
    };
    //Fläche positiver Immunzellen / Gesamttumorflächev -> ratio-pos-flaeche component -> 16, 0, id_2182
    observation -> tgt.data as data then
    {
        observation.component as component then
        {
            component.valueQuantity as quantity where "code.coding.code = 'tcell-surface-ratio'" then
            {
                observation->data.blockindex = 16;
                observation->data.groupindex = 0;
                observation->data.itemid     = 'id_2182';
                quantity.value as value ->data.values as values, 
                                values.unit  = 'percent', 
                                values.value = value;
            };
        };
    };
}

/* --------------------- Observation ROS1 IHC -------------------------- */
group TransformVBIHCObservationROS1CDS(source observation: Observation, target tgt: BackboneElement)
{
    //Date of Assessment -> 17, 0,id_2211
    //Phaenotyp -> 17, 0, id_2212
    //these two items shown before were mapped in the following group
    observation then TransformationObservationROS1DatePhanotypVorbefund(observation, tgt);
    
    //Ergebnis -> 17, 0, id_2219
    observation->tgt.data as data then
    {
        observation.valueCodeableConcept as valueCodeableConcept,
            valueCodeableConcept.coding as coding,
            coding.code as code then
        {
            observation->data.blockindex = 17;
            observation->data.groupindex = 0;
            observation->data.itemid = 'id_2219';
            code->data.values as values, values.value = code;
        };
    };
}


/*---------------------------------------------------------------------
                        Molekularpathologie (MP)                
------------------------------------------------------------------------ */
/* --------------- CISH Observation ---------------------- */
group TransformVBCISHObservationMPCDS(source observation: Observation, target tgt: BackboneElement)
{
    observation where "code.coding.code = 'ALK'" then TransformVBCISHObservationALKCDS(observation, tgt);
    observation where "code.coding.code = 'MET'" then TransformVBCISHObservationMETCDS(observation, tgt);
    observation where "code.coding.code = 'RET'" then TransformVBCISHObservationRETCDS(observation, tgt);
    observation where "code.coding.code = 'ROS1'" then TransformVBCISHObservationROS1CDS(observation, tgt);
}

/* --------------- FISH Observation ---------------------- */
group TransformVBFISHObservationMPCDS(source observation: Observation, target tgt: BackboneElement)
{
    observation where "code.coding.code = 'ALK'" then TransformVBFISHObservationALKCDS(observation, tgt);
    observation where "code.coding.code = 'MET'" then TransformVBFISHObservationMETCDS(observation, tgt);
    observation where "code.coding.code = 'RET'" then TransformVBFISHObservationRETCDS(observation, tgt);
    observation where "code.coding.code = 'ROS1'" then TransformVBFISHObservationROS1CDS(observation, tgt);
}

/* --------------------- Observation ALK CISH -------------------------- */
group TransformVBCISHObservationALKCDS(source observation: Observation, target tgt: BackboneElement)
{
    //Date of Assessment -> 3, 0,id_2098
    //Phaenotyp -> 3, 0, id_2099
    //these two items shown before were mapped in the following group
    observation then TransformationObservationALKDatePhanotypVorbefund(observation, tgt);

    //Ergebnis -> 3, 0, id_2112
    observation->tgt.data as data then
    {
        observation.valueCodeableConcept as valueCodeableConcept,
            valueCodeableConcept.coding as coding then
        {
            observation->data.blockindex = 3;
            observation->data.groupindex = 0;
            observation->data.itemid = 'id_2112';
            coding.code as code where "code = 'LA6576-8'" -> data.values as values, values.value = 'positiv';
            coding.code as code where "code = 'LA6577-6'" -> data.values as values, values.value = 'negativ';
            coding.code as code where "code = 'LA18198-4'" -> data.values as values, values.value = 'nicht auswertbar';
        };
    };
    
    //Positive Tumorzellen -> pos-tumor-zellen component -> 3, 0, id_2113
    observation -> tgt.data as data then
    {
        observation.component as component then
        {
            component.valueQuantity as quantity where "code.coding.code = 'C70460'" then
            {
                observation->data.blockindex = 3;
                observation->data.groupindex = 0;
                observation->data.itemid     = 'id_2113';
                quantity.value as value ->data.values as values, values.unit = 'percent', values.value = value;
            };
        };
    };
}

/* --------------------- Observation MET CISH -------------------------- */
group TransformVBCISHObservationMETCDS(source observation: Observation, target tgt: BackboneElement)
{
    //Date of Assessment -> 6, 0,id_2132
    //Phaenotyp -> 6, 0, id_2133
    //these two items shown before were mapped in the following group
    observation then TransformationObservationMETDatePhanotypVorbefund(observation, tgt);
    
    //Ergebnis -> 6, 0, id_2147
    observation->tgt.data as data then
    {
        observation.valueCodeableConcept as valueCodeableConcept,
            valueCodeableConcept.coding as coding then
        {
            observation->data.blockindex = 6;
            observation->data.groupindex = 0;
            observation->data.itemid = 'id_2147';
            coding.code as code where "code = 'positiv (high-level amplification)'" -> data.values as values, values.value = code;
            coding.code as code where "code = 'positiv (moderate-level amplification)'" -> data.values as values, values.value = code;
            coding.code as code where "code = 'LA6577-6'" -> data.values as values, values.value = 'negativ';
            coding.code as code where "code = 'LA18198-4'" -> data.values as values, values.value = 'nicht auswertbar';
        };
    };

    //Amplifikation -> amplification-level component -> 6, 0, id_2148
    observation -> tgt.data as data then
    {
        observation.component as component then
        {
            component.code where "code.coding.code = 'amplification-level'" then
            {
                component.valueCodeableConcept as valueCodeableConcept,
                valueCodeableConcept.coding as coding, 
                coding.code as code where "code ='LA9193-9'" then 
                {
                    observation -> data.blockindex = 6;
                    observation -> data.groupindex = 0;
                    observation -> data.itemid     = 'id_2148';
                    code.value as value -> data.values as values, values.value = 'Amplifikation high-level';
                };
                component.valueCodeableConcept as valueCodeableConcept,
                valueCodeableConcept.coding as coding, 
                coding.code as code where "code ='LA8982-6'" then 
                {
                    observation -> data.blockindex = 6;
                    observation -> data.groupindex = 0;
                    observation -> data.itemid     = 'id_2148';
                    code.value as value ->data.values as values, values.value = 'Amplifikation moderate-level';
                };
                component.valueCodeableConcept as valueCodeableConcept,
                valueCodeableConcept.coding as coding, 
                coding.code as code where "code ='LA32-8'" then 
                {
                    observation -> data.blockindex = 6;
                    observation -> data.groupindex = 0;
                    observation -> data.itemid     = 'id_2148';
                    code.value as value ->data.values as values, values.value = 'keine Amplifikation';
                };
            };
        };
    };
}

/* --------------------- Observation RET CISH -------------------------- */
group TransformVBCISHObservationRETCDS(source observation: Observation, target tgt: BackboneElement)
{
    //Date of Assessment -> 20, 0,id_2183
    //Phaenotyp -> 20, 0, id_2184
    //these two items shown before were mapped in the following group
    observation then TransformationObservationRETDatePhanotypVorbefund(observation, tgt);
    
    //Ergebnis -> 20, 0, id_2191
    observation->tgt.data as data then
    {
        observation.valueCodeableConcept as valueCodeableConcept,
            valueCodeableConcept.coding as coding then
        {
            observation->data.blockindex = 20;
            observation->data.groupindex = 0;
            observation->data.itemid = 'id_2191';
            coding.code as code where "code = 'LA6576-8'" -> data.values as values, values.value = 'positiv';
            coding.code as code where "code = 'LA6577-6'" -> data.values as values, values.value = 'negativ';
            coding.code as code where "code = 'LA18198-4'" -> data.values as values, values.value = 'nicht auswertbar';
        };
    };

    //Positive Tumorzellen -> pos-tumor-zellen component -> 20, 0, id_2192
    observation -> tgt.data as data then
    {
        observation.component as component then
        {
            component.valueQuantity as quantity where "code.coding.code = 'C70460'" then
            {
                    observation->data.blockindex = 20;
                    observation->data.groupindex = 0;
                    observation->data.itemid     = 'id_2192';
                    quantity.value as value ->data.values as values, values.unit = 'percent', values.value = value;
            };
        };
    };
}

/* --------------------- Observation ROS1 CISH ------------------------- */
group TransformVBCISHObservationROS1CDS(source observation: Observation, target tgt: BackboneElement)
{
    //Date of Assessment -> 17, 0,id_2211
    //Phaenotyp -> 17, 0, id_2212
    //these two items shown before were mapped in the following group
    observation then TransformationObservationROS1DatePhanotypVorbefund(observation, tgt);
    
    //Ergebnis -> 17, 0, id_2225
    observation->tgt.data as data then
    {
        observation.valueCodeableConcept as valueCodeableConcept,
            valueCodeableConcept.coding as coding then
        {
            observation->data.blockindex = 17;
            observation->data.groupindex = 0;
            observation->data.itemid = 'id_2225';
            coding.code as code where "code = 'LA6576-8'" -> data.values as values, values.value = 'positiv';
            coding.code as code where "code = 'LA6577-6'" -> data.values as values, values.value = 'negativ';
            coding.code as code where "code = 'LA18198-4'" -> data.values as values, values.value = 'nicht auswertbar';
        };
    };
    
    //Positive Tumorzellen -> pos-tumor-zellen component -> 17, 0, id_2226
    observation -> tgt.data as data then
    {
        observation.component as component then
        {
            component.valueQuantity as quantity where "code.coding.code = 'C70460'" then
            {
                observation->data.blockindex = 17;
                observation->data.groupindex = 0;
                observation->data.itemid     = 'id_2226';
                quantity.value as value ->data.values as values, values.unit = 'percent', values.value = value;
            };
        };
    };

    //Polysomie -> polysomie component -> 17, 0, id_2227
    observation -> tgt.data as data then
    {
        observation.component as component then
        {
            component.valueQuantity as quantity where "code.coding.code = 'C36331'" then
            {
                observation->data.blockindex = 17;
                observation->data.groupindex = 0;
                observation->data.itemid     = 'id_2227';
                quantity.value as value ->data.values as values, values.unit = 'percent', values.value = value;
            };
        };
    };
}

/* --------------------- Observation ALK FISH -------------------------- */
group TransformVBFISHObservationALKCDS(source observation: Observation, target tgt: BackboneElement)
{
    //Date of Assessment -> 3, 0,id_2098
    //Phaenotyp -> 3, 0, id_2099
    //these two items shown before were mapped in the following group
    observation then TransformationObservationALKDatePhanotypVorbefund(observation, tgt);
    
    //Ergebnis -> 3, 0, id_2119
    observation->tgt.data as data then
    {
        observation.valueCodeableConcept as valueCodeableConcept,
            valueCodeableConcept.coding as coding then
        {
            observation->data.blockindex = 3;
            observation->data.groupindex = 0;
            observation->data.itemid = 'id_2119';
            coding.code as code where "code = 'LA6576-8'" -> data.values as values, values.value = 'positiv';
            coding.code as code where "code = 'LA6577-6'" -> data.values as values, values.value = 'negativ';
            coding.code as code where "code = 'LA18198-4'" -> data.values as values, values.value = 'nicht auswertbar';
        };
    };
    
    //Positive Tumorzellen -> pos-tumor-zellen component -> 3, 0, id_2120
    observation -> tgt.data as data then
    {
        observation.component as component then
        {
            component.valueQuantity as quantity where "code.coding.code = 'C70460'" then
            {
                observation->data.blockindex = 3;
                observation->data.groupindex = 0;
                observation->data.itemid     = 'id_2120';
                quantity.value as value ->data.values as values, values.unit = 'percent', values.value = value;
            };
        };
    };

    //Polysomie -> polysomie -> 3, 0, id_2121
    observation -> tgt.data as data then
    {
        observation.component as component then
        {
            component.valueQuantity as quantity where "code.coding.code = 'C36331'" then
            {
                observation->data.blockindex = 3;
                observation->data.groupindex = 0;
                observation->data.itemid     = 'id_2121';
                quantity.value as value -> data.values as values, values.unit = 'percent', values.value = value;
            };
        };
    };
}

/* --------------------- Observation MET FISH -------------------------- */
group TransformVBFISHObservationMETCDS(source observation: Observation, target tgt: BackboneElement)
{
    //Date of Assessment -> 6, 0,id_2132
    //Phaenotyp -> 6, 0, id_2133
    //these two items shown before were mapped in the following group
    observation then TransformationObservationMETDatePhanotypVorbefund(observation, tgt);
    
    //Ergebnis -> 6, 0, id_2154
    observation->tgt.data as data then
    {
        observation.valueCodeableConcept as valueCodeableConcept,
            valueCodeableConcept.coding as coding then
        {
            observation->data.blockindex = 6;
            observation->data.groupindex = 0;
            observation->data.itemid = 'id_2154';
            coding.code as code where "code = 'LA6576-8'" -> data.values as values, values.value = 'positiv';
            coding.code as code where "code = 'LA6577-6'" -> data.values as values, values.value = 'negativ';
            coding.code as code where "code = 'LA18198-4'" -> data.values as values, values.value = 'nicht auswertbar';
        };
    };
    
    //Amplifikation -> amplification-level component -> 6, 0, id_2155
    observation -> tgt.data as data then 
    {
        observation.component as component then
        {
            component.valueCodeableConcept where "code.coding.code = 'amplification-level'" then
            {
                component.valueCodeableConcept as valueCodeableConcept,
                valueCodeableConcept.coding as coding then  
                {
                    observation-> data.blockindex = 6;
                    observation-> data.groupindex = 0;
                    observation-> data.itemid = 'id_2155';
                    coding.code as code where "code = 'LA9193-9'" -> data.values as values, values.value = 'Amplifikation high-level';
                    coding.code as code where "code = 'LA8982-6'" -> data.values as values, values.value = 'Amplifikation intermediate-level';
                    coding.code as code where "code = 'LA9194-7'" -> data.values as values, values.value = 'Amplifikation low-level';
                    coding.code as code where "code = 'LA32-8'" -> data.values as values, values.value = 'negativ';
                    coding.code as code where "code = 'LA11884-6'" -> data.values as values, values.value = 'nicht auswertbar';
                };
            };
        };
    };
    
    //Prozentzahl an Zellen mit mehr als 15 MET-Signalen pro Zelle (Positiv ≥ 10 %) bei einer high-level Amplifikation
    //15-met-ratio component -> 6, 0, id_2156
    observation -> tgt.data as data then
    {
        observation.component as component then
        {
            component.valueQuantity as quantity where "code.coding.code = '15-met-ratio'" then
            {
                observation -> data.blockindex = 6;
                observation -> data.groupindex = 0;
                observation -> data.itemid     = 'id_2156';
                quantity.value as value -> data.values as values, values.unit = 'percent', values.value = value;
            };
        };
    };

    //Prozentzahl an Zellen mit mehr als 5 MET-Signalen pro Zelle (Positiv ≥ 50 %) bei einer intermediate-level Amplifikation
    //5-met-ratio component -> 6, 0, id_2157
    observation -> tgt.data as data then
    {
        observation.component as component then
        {
            component.valueQuantity as quantity where "code.coding.code = '5-met-ratio'" then
            {
                observation -> data.blockindex = 6;
                observation -> data.groupindex = 0;
                observation -> data.itemid     = 'id_2157';
                quantity.value as value -> data.values as values, values.unit = 'percent', values.value = value;
            };
        };
    };
    //Prozentzahl an Zellen mit mehr als 4 MET-Signalen pro Zelle (Positiv ≥ 40 %) bei einer low-level Amplifikation
    //4-met-ratio component -> 6, 0, id_2158
    observation -> tgt.data as data then
    {
        observation.component as component then
        {
            component.valueQuantity as quantity where "code.coding.code = '4-met-ratio'" then
            {
                observation -> data.blockindex = 6;
                observation -> data.groupindex = 0;
                observation -> data.itemid     = 'id_2158';
                quantity.value as value -> data.values as values, values.unit = 'percent', values.value = value;
            };
        };
    };
    //Gezählte Tumorzellen
    //gezaehlteTumorzellen component > 6, 0, id_2159
    observation -> tgt.data as data then
    {
        observation.component as component then
        {
            component.valueInteger as valueInteger where "code.coding.code = 'C0007584'" then
            {
                observation  -> data.blockindex = 6;
                observation  -> data.groupindex = 0;
                observation  -> data.itemid     = 'id_2159';
                valueInteger -> data.values as values, values.unit = 'count', values.value = valueInteger;
            };
        };
    };
    //MET Signale
    //met-signale component -> 6, 0, id_2160
    observation -> tgt.data as data then
    {
        observation.component as component then
        {
            component.valueInteger as valueInteger where "code.coding.code = 'met-signal-count'" then
            {
                observation  -> data.blockindex = 6;
                observation  -> data.groupindex = 0;
                observation  -> data.itemid     = 'id_2160';
                valueInteger -> data.values as values, values.unit = 'count', values.value = valueInteger;
            };
        };
    };
    //CEN Signale
    //CEN-signale  -> 6, 0, id_2161
    observation -> tgt.data as data then
    {
        observation.component as component then
        {
            component.valueInteger as valueInteger where "code.coding.code = 'cen-signal-count'" then
            {
                observation  -> data.blockindex = 6;
                observation  -> data.groupindex = 0;
                observation  -> data.itemid     = 'id_2161';
                valueInteger -> data.values as values, values.unit = 'count', values.value = valueInteger;
            };
        };
    };
    //Quotient MET/CEN7 Signale
    //quot-met-cen-signal component -> 6, 0, id_2162
    observation -> tgt.data as data then
    {
        observation.component as component then
        {
            component.valueInteger as valueInteger where "code.coding.code = 'met-cen-signal-ratio'" then
            {
                observation  -> data.blockindex = 6;
                observation  -> data.groupindex = 0;
                observation  -> data.itemid     = 'id_2162';
                valueInteger -> data.values as values, values.unit = 'count', values.value = valueInteger;
            };
        };
    };
    //Durchschnitt MET-Genkopiezahl/Zelle (Positiv ≥ 6)
    //met-copy-pro-zell component -> 6, 0, id_2163
    observation -> tgt.data as data then
    {
        observation.component as component then
        {
            component.valueInteger as valueInteger where "code.coding.code = 'met-copy-per-cell'" then
            {
                observation  -> data.blockindex = 6;
                observation  -> data.groupindex = 0;
                observation  -> data.itemid     = 'id_2163';
                valueInteger -> data.values as values, values.unit = 'count', values.value = valueInteger;
            };
        };
    };
    //Polysomie
    //polysomie component -> 6, 0, id_2164
    observation -> tgt.data as data then
    {
        observation.component as component then
        {
            component.valueQuantity as quantity where "code.coding.code = 'C36331'" then
            {
                observation  -> data.blockindex = 6;
                observation  -> data.groupindex = 0;
                observation  -> data.itemid     = 'id_2164';
                quantity.value as value -> data.values as values, values.unit = 'percent', values.value = value;
            };
        };
    };
}

/* --------------------- Observation RET FISH -------------------------- */
group TransformVBFISHObservationRETCDS(source observation: Observation, target tgt: BackboneElement)
{
        
    //Date of Assessment -> 20, 0,id_2183
    //Phaenotyp -> 20, 0, id_2184
    //these two items shown before were mapped in the following group
    observation then TransformationObservationRETDatePhanotypVorbefund(observation, tgt);
    
    //Ergebnis -> 20, 0, id_2198
    observation->tgt.data as data then
    {
        observation.valueCodeableConcept as valueCodeableConcept,
            valueCodeableConcept.coding as coding then
        {
            observation->data.blockindex = 20;
            observation->data.groupindex = 0;
            observation->data.itemid = 'id_2198';
            coding.code as code where "code = 'LA6576-8'" -> data.values as values, values.value = 'positiv';
            coding.code as code where "code = 'LA6577-6'" -> data.values as values, values.value = 'negativ';
            coding.code as code where "code = 'LA18198-4'" -> data.values as values, values.value = 'nicht auswertbar';
        };
    };
    
    //Positive Tumorzellen -> pos-tumor-zellen component -> 20, 0, id_2199
    observation -> tgt.data as data then
    {
        observation.component as component then
        {
            component.valueQuantity as quantity where "code.coding.code = 'C70460'" then
            {
                    observation -> data.blockindex = 20;
                    observation -> data.groupindex = 0;
                    observation -> data.itemid     = 'id_2199';
                    quantity.value as value -> data.values as values, values.unit = 'percent', values.value = value;
            };
        };
    };
    //Polysomie
    //polysomie component -> 20, 0, id_2200
    observation -> tgt.data as data then
    {
        observation.component as component then
        {
            component.valueQuantity as quantity where "code.coding.code = 'C36331'" then
            {
                    observation -> data.blockindex = 20;
                    observation -> data.groupindex = 0;
                    observation -> data.itemid     = 'id_2200';
                    quantity.value as value -> data.values as values, values.unit = 'percent', values.value = value;
            };
        };
    };
}

/* --------------------- Observation ROS1 FISH ------------------------- */
group TransformVBFISHObservationROS1CDS(source observation: Observation, target tgt: BackboneElement)
{
    //Date of Assessment -> 17, 0,id_2211
    //Phaenotyp -> 17, 0, id_2212
    //these two items shown before were mapped in the following group
    observation then TransformationObservationROS1DatePhanotypVorbefund(observation, tgt);
    
    //Ergebnis -> 17, 0, id_2233
    observation->tgt.data as data then
    {
        observation.valueCodeableConcept as valueCodeableConcept,
            valueCodeableConcept.coding as coding then
        {
            observation->data.blockindex = 17;
            observation->data.groupindex = 0;
            observation->data.itemid = 'id_2233';
            coding.code as code where "code = 'LA6576-8'" -> data.values as values, values.value = 'positiv';
            coding.code as code where "code = 'LA6577-6'" -> data.values as values, values.value = 'negativ';
            coding.code as code where "code = 'LA18198-4'" -> data.values as values, values.value = 'nicht auswertbar';
        };
    };
    
    //Positive Tumorzellen -> pos-tumor-zellen component -> 17, 0, id_2234
    observation -> tgt.data as data then
    {
        observation.component as component then
        {
            component.valueQuantity as quantity where "code.coding.code = 'C70460'" then
            {
                observation->data.blockindex = 17;
                observation->data.groupindex = 0;
                observation->data.itemid     = 'id_2234';
                quantity.value as value ->data.values as values, values.unit = 'percent', values.value = value;
            };
        };
    };
    //Polysomie -> polysomie component -> 17, 0, id_2235
    observation -> tgt.data as data then
    {
        observation.component as component then
        {
            component.valueQuantity as quantity where "code.coding.code = 'C36331'" then
            {
                observation->data.blockindex = 17;
                observation->data.groupindex = 0;
                observation->data.itemid     = 'id_2235';
                quantity.value as value ->data.values as values, values.unit = 'percent', values.value = value;
            };
        };
    };
}

/*----------------------------------------------------------------------
                            Fusion NGS                                  
------------------------------------------------------------------------ */
group TransformVBObservationFSCDS(source observation: Observation, target tgt: BackboneElement, target index: RepeatIndex)
{
    observation where "code.coding.code = 'ALK'" then TransformVBFSObservationALKCDS(observation, tgt);
    observation where "code.coding.code = 'RET'" then TransformVBFSObservationRETCDS(observation, tgt);
    observation where "code.coding.code = 'ROS1'" then TransformVBFSObservationROS1CDS(observation, tgt);
    observation where "code.coding.code = 'NTRK1'" then TransformVBFSObservationNTRK1CDS(observation, tgt);
    observation where "code.coding.code = 'NTRK2'" then TransformVBFSObservationNTRK2CDS(observation, tgt);
    observation where "code.coding.code = 'NTRK3'" then TransformVBFSObservationNTRK3CDS(observation, tgt);
    observation where "code.coding.code = 'FGFR1'" then TransformVBFSObservationFGFR1CDS(observation, tgt);
    observation where "code.coding.code = 'FGFR2'" then TransformVBFSObservationFGFR2CDS(observation, tgt);
    observation where "code.coding.code = 'FGFR3'" then TransformVBFSObservationFGFR3CDS(observation, tgt);
    observation where "code.coding.code = 'Sonstige Fusion NGS'" then TransformVBFSObservationSonstigeCDS(observation, tgt, index);
}

/* ------------------ Observation ALK FusionNGS ------------------------ */
group TransformVBFSObservationALKCDS(source observation: Observation, target tgt: BackboneElement)
{
    //Date of Assessment -> 3, 0,id_2098
    //Phaenotyp -> 3, 0, id_2099
    //these two items shown before were mapped in the following group
    observation then TransformationObservationALKDatePhanotypVorbefund(observation, tgt);

    //Ergebnis -> 3, 0, id_2127
    observation->tgt.data as data then
    {
        observation.valueCodeableConcept as valueCodeableConcept,
            valueCodeableConcept.coding as coding then
        {
            observation->data.blockindex = 3;
            observation->data.groupindex = 0;
            observation->data.itemid = 'id_2127';
            coding.code as code where "code = 'LA6576-8'" -> data.values as values, values.value = 'positiv';
            coding.code as code where "code = 'LA6577-6'" -> data.values as values, values.value = 'negativ';
            coding.code as code where "code = 'LA18198-4'" -> data.values as values, values.value = 'nicht auswertbar';
        };
    };
    
    //Fusionspartner -> fusionspartner component -> 3, 0, id_2128
    observation -> tgt.data as data then
    {
        observation.component as component, component.code where "code.coding.code = 'C28510'" then
        {
            component.valueString as valueString then
            {
                observation -> data.blockindex = 3;
                observation -> data.groupindex = 0;
                observation -> data.itemid     = 'id_2128';
                valueString -> data.values as values, values.value = valueString;
            };
        };
    };
    //Anzahl der Fusionsreads -> anzahl-der-fusionsreads component -> 3, 0, id_2129
    observation -> tgt.data as data then
    {
        observation.component as component then
        {
            component.valueInteger as valueInteger where "code.coding.code = '82121-5'" then
            {
                observation  -> data.blockindex = 3;
                observation  -> data.groupindex = 0;
                observation  -> data.itemid     = 'id_2129';
                valueInteger -> data.values as values, values.unit = 'count', values.value = valueInteger;
            };
        };
    };
    //5' Fusionspartner Exon -> fusionspartner-exon component -> 3, 0, id_2130
    observation -> tgt.data as data then
    {
        observation.component as component then
        {
            component.valueInteger as valueInteger where "code.coding.code = 'fusionspartner-exon'" then
            {
                observation  -> data.blockindex = 3;
                observation  -> data.groupindex = 0;
                observation  -> data.itemid     = 'id_2130';
                valueInteger -> data.values as values, values.unit = 'count', values.value = valueInteger;
            };
        };
    };
    //ALK Exon -> exon component -> 3, 0, id_2131
    observation -> tgt.data as data then
    {
        observation.component as component then
        {
            component.valueInteger as valueInteger where "code.coding.code = 'C13231'" then
            {
                observation  -> data.blockindex = 3;
                observation  -> data.groupindex = 0;
                observation  -> data.itemid     = 'id_2131';
                valueInteger -> data.values as values, values.unit = 'count', values.value = valueInteger;
            };
        };
    };
}

/* ------------------ Observation RET FusionNGS ------------------------ */
group TransformVBFSObservationRETCDS(source observation: Observation, target tgt: BackboneElement)
{
    //Date of Assessment -> 20, 0,id_2183
    //Phaenotyp -> 20, 0, id_2184
    //these two items shown before were mapped in the following group
    observation then TransformationObservationRETDatePhanotypVorbefund(observation, tgt);

    //Ergebnis -> 20, 0, id_2206
    observation->tgt.data as data then
    {
        observation.valueCodeableConcept as valueCodeableConcept,
            valueCodeableConcept.coding as coding then
        {
            observation->data.blockindex = 20;
            observation->data.groupindex = 0;
            observation->data.itemid = 'id_2206';
            coding.code as code where "code = 'LA6576-8'" -> data.values as values, values.value = 'positiv';
            coding.code as code where "code = 'LA6577-6'" -> data.values as values, values.value = 'negativ';
            coding.code as code where "code = 'LA18198-4'" -> data.values as values, values.value = 'nicht auswertbar';
        };
    };
    
    //Fusionspartner -> fusionspartner component -> 20, 0, id_2207
    observation -> tgt.data as data then
    {
        observation.component as component, component.code where "code.coding.code = 'C28510'" then
        {
            component.valueString as valueString then
            {
                observation -> data.blockindex = 20;
                observation -> data.groupindex = 0;
                observation -> data.itemid     = 'id_2207';
                valueString -> data.values as values, values.value = valueString;
            };
        };
    };
    //Anzahl der Fusionsreads -> anzahl-der-fusionsreads component -> 20, 0, id_2208
    observation -> tgt.data as data then
    {
        observation.component as component then
        {
            component.valueInteger as valueInteger where "code.coding.code = '82121-5'" then
            {
                observation  -> data.blockindex = 20;
                observation  -> data.groupindex = 0;
                observation  -> data.itemid     = 'id_2208';
                valueInteger -> data.values as values, values.unit = 'count', values.value = valueInteger;
            };
        };
    };
    //5' Fusionspartner Exon -> fusionspartner-exon component -> 20, 0, id_2209
    observation -> tgt.data as data then
    {
        observation.component as component then
        {
            component.valueInteger as valueInteger where "code.coding.code = 'fusionspartner-exon'" then
            {
                observation  -> data.blockindex = 20;
                observation  -> data.groupindex = 0;
                observation  -> data.itemid     = 'id_2209';
                valueInteger -> data.values as values, values.unit = 'count', values.value = valueInteger;
            };
        };
    };
    //RET Exon -> fusionspartner-exon component -> 20, 0, id_2210
    observation -> tgt.data as data then
    {
        observation.component as component then
        {
            component.valueInteger as valueInteger where "code.coding.code = 'C13231'" then
            {
                observation  -> data.blockindex = 20;
                observation  -> data.groupindex = 0;
                observation  -> data.itemid     = 'id_2210';
                valueInteger -> data.values as values, values.unit = 'count', values.value = valueInteger;
            };
        };
    };
}

/* ----------------- Observation ROS1 FusionNGS ------------------------ */
group TransformVBFSObservationROS1CDS(source observation: Observation, target tgt: BackboneElement)
{
    //Date of Assessment -> 17, 0,id_2211
    //Phaenotyp -> 17, 0, id_2212
    //these two items shown before were mapped in the following group
    observation then TransformationObservationROS1DatePhanotypVorbefund(observation, tgt);

    //Ergebnis -> 17, 0, id_2241
    observation->tgt.data as data then
    {
        observation.valueCodeableConcept as valueCodeableConcept,
            valueCodeableConcept.coding as coding then
        {
            observation->data.blockindex = 17;
            observation->data.groupindex = 0;
            observation->data.itemid = 'id_2241';
            coding.code as code where "code = 'LA6576-8'" -> data.values as values, values.value = 'positiv';
            coding.code as code where "code = 'LA6577-6'" -> data.values as values, values.value = 'negativ';
            coding.code as code where "code = 'LA18198-4'" -> data.values as values, values.value = 'nicht auswertbar';
        };
    };
    
    //Fusionspartner -> fusionspartner component -> 17, 0, id_2242
    observation -> tgt.data as data then
    {
        observation.component as component, component.code where "code.coding.code = 'C28510'" then
        {
            component.valueString as valueString then
            {
                observation -> data.blockindex = 17;
                observation -> data.groupindex = 0;
                observation -> data.itemid     = 'id_2242';
                valueString -> data.values as values, values.value = valueString;
            };
        };
    };
    //Anzahl der Fusionsreads -> anzahl-der-fusionsreads component -> 17, 0, id_2243
    observation -> tgt.data as data then
    {
        observation.component as component then
        {
            component.valueInteger as valueInteger where "code.coding.code = '82121-5'" then
            {
                observation  -> data.blockindex = 17;
                observation  -> data.groupindex = 0;
                observation  -> data.itemid     = 'id_2243';
                valueInteger -> data.values as values, values.unit = 'count', values.value = valueInteger;
            };
        };
    };
    //5' Fusionspartner Exon -> fusionspartner-exon component -> 17, 0, id_2244
    observation -> tgt.data as data then
    {
        observation.component as component then
        {
            component.valueInteger as valueInteger where "code.coding.code = 'fusionspartner-exon'" then
            {
                observation  -> data.blockindex = 17;
                observation  -> data.groupindex = 0;
                observation  -> data.itemid     = 'id_2244';
                valueInteger -> data.values as values, values.unit = 'count', values.value = valueInteger;
            };
        };
    };
    //ROS1 Exon -> fusionspartner-exon component -> 17, 0, id_2245
    observation -> tgt.data as data then
    {
        observation.component as component then
        {
            component.valueInteger as valueInteger where "code.coding.code = 'C13231'" then
            {
                observation  -> data.blockindex = 17;
                observation  -> data.groupindex = 0;
                observation  -> data.itemid     = 'id_2245';
                valueInteger -> data.values as values, values.unit = 'count', values.value = valueInteger;
            };
        };
    };
}

/* ----------------- Observation NTRK1 FusionNGS ----------------------- */
group TransformVBFSObservationNTRK1CDS(source observation: Observation, target tgt: BackboneElement)
{
    //Date Of Assesment -> 8, 0, id_2540
    observation-> tgt.data as data then
    {
        observation.effectiveDateTime as dateOfAssessment then
        {
            observation->data.blockindex = 8;
            observation->data.groupindex = 0;
            observation->data.itemid     = 'id_2540';
            dateOfAssessment-> data.values as values, values.value = dateOfAssessment;
        };
    };

    //Ergebnis -> 8, 0, id_2547
    observation->tgt.data as data then
    {
        observation.valueCodeableConcept as valueCodeableConcept,
            valueCodeableConcept.coding as coding then
        {
            observation->data.blockindex = 8;
            observation->data.groupindex = 0;
            observation->data.itemid = 'id_2547';
            coding.code as code where "code = 'LA6576-8'" -> data.values as values, values.value = 'positiv';
            coding.code as code where "code = 'LA6577-6'" -> data.values as values, values.value = 'negativ';
            coding.code as code where "code = 'LA18198-4'" -> data.values as values, values.value = 'nicht auswertbar';
        };
    };
    
    //Fusionspartner -> fusionspartner component -> 8, 0, id_2548
    observation -> tgt.data as data then
    {
        observation.component as component, component.code where "code.coding.code = 'C28510'" then
        {
            component.valueString as valueString then
            {
                observation -> data.blockindex = 8;
                observation -> data.groupindex = 0;
                observation -> data.itemid     = 'id_2548';
                valueString -> data.values as values,values.value = valueString;
            };
        };
    };
    //Anzahl der Fusionsreads -> anzahl-der-fusionsreads component -> 8, 0, id_2549
    observation -> tgt.data as data then
    {
        observation.component as component then
        {
            component.valueInteger as valueInteger where "code.coding.code = '82121-5'" then
            {
                observation  -> data.blockindex = 8;
                observation  -> data.groupindex = 0;
                observation  -> data.itemid     = 'id_2549';
                valueInteger -> data.values as values, values.unit = 'count', values.value = valueInteger;
            };
        };
    };
    //5' Fusionspartner Exon -> fusionspartner-exon component -> 8, 0, id_2550
    observation -> tgt.data as data then
    {
        observation.component as component then
        {
            component.valueInteger as valueInteger where "code.coding.code = 'fusionspartner-exon'" then
            {
                observation  -> data.blockindex = 8;
                observation  -> data.groupindex = 0;
                observation  -> data.itemid     = 'id_2550';
                valueInteger -> data.values as values, values.unit = 'count', values.value = valueInteger;
            };
        };
    };
}

/* ----------------- Observation NTRK2 FusionNGS ----------------------- */
group TransformVBFSObservationNTRK2CDS(source observation: Observation, target tgt: BackboneElement)
{
    //Date Of Assesment -> 9, 0, id_2592
    observation-> tgt.data as data then
    {
        observation.effectiveDateTime as dateOfAssessment then
        {
            observation -> data.blockindex = 9;
            observation -> data.groupindex = 0;
            observation -> data.itemid     = 'id_2592';
            dateOfAssessment-> data.values as values, values.value = dateOfAssessment;
        };
    };
    //Ergebnis -> 9, 0, id_2596
    observation->tgt.data as data then
    {
        observation.valueCodeableConcept as valueCodeableConcept,
            valueCodeableConcept.coding as coding then
        {
            observation->data.blockindex = 9;
            observation->data.groupindex = 0;
            observation->data.itemid = 'id_2596';
            coding.code as code where "code = 'LA6576-8'" -> data.values as values, values.value = 'positiv';
            coding.code as code where "code = 'LA6577-6'" -> data.values as values, values.value = 'negativ';
            coding.code as code where "code = 'LA18198-4'" -> data.values as values, values.value = 'nicht auswertbar';
        };
    };
    
    //Fusionspartner -> fusionspartner component -> 9, 0, id_2597
    observation -> tgt.data as data then
    {
        observation.component as component, component.code where "code.coding.code = 'C28510'" then
        {
            component.valueString as valueString then
            {
                observation -> data.blockindex = 9;
                observation -> data.groupindex = 0;
                observation -> data.itemid     = 'id_2597';
                valueString -> data.values as values, values.value = valueString;
            };
        };
    };
    //Anzahl der Fusionsreads -> anzahl-der-fusionsreads component -> 9, 0, id_2598
    observation -> tgt.data as data then
    {
        observation.component as component then
        {
            component.valueInteger as valueInteger where "code.coding.code = '82121-5'" then
            {
                observation  -> data.blockindex = 9;
                observation  -> data.groupindex = 0;
                observation  -> data.itemid     = 'id_2598';
                valueInteger -> data.values as values, values.unit = 'count', values.value = valueInteger;
            };
        };
    };
    //5' Fusionspartner Exon -> fusionspartner-exon component -> 9, 0, id_2599
    observation -> tgt.data as data then
    {
        observation.component as component then
        {
            component.valueInteger as valueInteger where "code.coding.code = 'fusionspartner-exon'" then
            {
                observation  -> data.blockindex = 9;
                observation  -> data.groupindex = 0;
                observation  -> data.itemid     = 'id_2599';
                valueInteger -> data.values as values, values.unit = 'count', values.value = valueInteger;
            };
        };
    };
}

/* ----------------- Observation NTRK3 FusionNGS ----------------------- */
group TransformVBFSObservationNTRK3CDS(source observation: Observation, target tgt: BackboneElement)
{
    //Date Of Assesment -> 10, 0, id_2584
    observation-> tgt.data as data then
    {
        observation.effectiveDateTime as dateOfAssessment then
        {
            observation->data.blockindex = 10;
            observation->data.groupindex = 0;
            observation->data.itemid     = 'id_2584';
            dateOfAssessment-> data.values as values, values.value = dateOfAssessment;
        };
    };

    //Ergebnis -> 10, 0, id_2588
    observation->tgt.data as data then
    {
        observation.valueCodeableConcept as valueCodeableConcept,
            valueCodeableConcept.coding as coding then
        {
            observation->data.blockindex = 10;
            observation->data.groupindex = 0;
            observation->data.itemid = 'id_2588';
            coding.code as code where "code = 'LA6576-8'" -> data.values as values, values.value = 'positiv';
            coding.code as code where "code = 'LA6577-6'" -> data.values as values, values.value = 'negativ';
            coding.code as code where "code = 'LA18198-4'" -> data.values as values, values.value = 'nicht auswertbar';
        };
    };
    
    //Fusionspartner -> fusionspartner component -> 10, 0, id_2589
    observation -> tgt.data as data then
    {
        observation.component as component, component.code where "code.coding.code = 'C28510'" then
        {
            component.valueString as valueString then
            {
                observation -> data.blockindex = 10;
                observation -> data.groupindex = 0;
                observation -> data.itemid     = 'id_2589';
                valueString -> data.values as values, values.value = valueString;
            };
        };
    };
    //Anzahl der Fusionsreads -> anzahl-der-fusionsreads component -> 10, 0, id_2590
    observation -> tgt.data as data then
    {
        observation.component as component then
        {
            component.valueInteger as valueInteger where "code.coding.code = '82121-5'" then
            {
                observation  -> data.blockindex = 10;
                observation  -> data.groupindex = 0;
                observation  -> data.itemid     = 'id_2590';
                valueInteger -> data.values as values, values.unit = 'count', values.value = valueInteger;
            };
        };
    };
    //5' Fusionspartner Exon -> fusionspartner-exon component -> 10, 0, id_2591
    observation -> tgt.data as data then
    {
        observation.component as component then
        {
            component.valueInteger as valueInteger where "code.coding.code = 'fusionspartner-exon'" then
            {
                observation  -> data.blockindex = 10;
                observation  -> data.groupindex = 0;
                observation  -> data.itemid     = 'id_2591';
                valueInteger -> data.values as values, values.unit = 'count', values.value = valueInteger;
            };
        };
    };
}

/* ---------------- Observation FGFR1 FusionNGS ------------------------ */
group TransformVBFSObservationFGFR1CDS(source observation: Observation, target tgt: BackboneElement)
{
    //Date Of Assesment -> 11, 0, id_2576
    observation-> tgt.data as data then
    {
        observation.effectiveDateTime as dateOfAssessment then
        {
            observation->data.blockindex = 11;
            observation->data.groupindex = 0;
            observation->data.itemid     = 'id_2576';
            dateOfAssessment-> data.values as values, values.value = dateOfAssessment;
        };
    };
    //Ergebnis -> 11, 0, id_2580
    observation->tgt.data as data then
    {
        observation.valueCodeableConcept as valueCodeableConcept,
            valueCodeableConcept.coding as coding then
        {
            observation->data.blockindex = 11;
            observation->data.groupindex = 0;
            observation->data.itemid = 'id_2580';
            coding.code as code where "code = 'LA6576-8'" -> data.values as values, values.value = 'positiv';
            coding.code as code where "code = 'LA6577-6'" -> data.values as values, values.value = 'negativ';
            coding.code as code where "code = 'LA18198-4'" -> data.values as values, values.value = 'nicht auswertbar';
        };
    };
    
    //Fusionspartner -> fusionspartner component -> 11, 0, id_2581
    observation -> tgt.data as data then
    {
        observation.component as component, component.code where "code.coding.code = 'C28510'" then
        {
            component.valueString as valueString then
            {
                observation -> data.blockindex = 11;
                observation -> data.groupindex = 0;
                observation -> data.itemid     = 'id_2581';
                valueString -> data.values as values, values.value = valueString;
            };
        };
    };
    //Anzahl der Fusionsreads -> anzahl-der-fusionsreads component -> 11, 0, id_2582
    observation -> tgt.data as data then
    {
        observation.component as component then
        {
            component.valueInteger as valueInteger where "code.coding.code = '82121-5'" then
            {
                observation  -> data.blockindex = 11;
                observation  -> data.groupindex = 0;
                observation  -> data.itemid     = 'id_2582';
                valueInteger -> data.values as values, values.unit = 'count', values.value = valueInteger;
            };
        };
    };
    //5' Fusionspartner Exon -> fusionspartner-exon component -> 11, 0, id_2583
    observation -> tgt.data as data then
    {
        observation.component as component then
        {
            component.valueInteger as valueInteger where "code.coding.code = 'fusionspartner-exon'" then
            {
                observation  -> data.blockindex = 11;
                observation  -> data.groupindex = 0;
                observation  -> data.itemid     = 'id_2583';
                valueInteger -> data.values as values, values.unit = 'count', values.value = valueInteger;
            };
        };
    };
}

/* ---------------- Observation FGFR2 FusionNGS ------------------------ */
group TransformVBFSObservationFGFR2CDS(source observation: Observation, target tgt: BackboneElement)
{
    //Date Of Assesment -> 12, 0, id_2568
    observation-> tgt.data as data then
    {
        observation.effectiveDateTime as dateOfAssessment then
        {
            observation->data.blockindex = 12;
            observation->data.groupindex = 0;
            observation->data.itemid     = 'id_2568';
            dateOfAssessment-> data.values as values, values.value = dateOfAssessment;
        };
    };
    //Ergebnis -> 12, 0, id_2572
    observation->tgt.data as data then
    {
        observation.valueCodeableConcept as valueCodeableConcept,
            valueCodeableConcept.coding as coding then
        {
            observation->data.blockindex = 12;
            observation->data.groupindex = 0;
            observation->data.itemid = 'id_2572';
            coding.code as code where "code = 'LA6576-8'" -> data.values as values, values.value = 'positiv';
            coding.code as code where "code = 'LA6577-6'" -> data.values as values, values.value = 'negativ';
            coding.code as code where "code = 'LA18198-4'" -> data.values as values, values.value = 'nicht auswertbar';
        };
    };
    
    //Fusionspartner -> fusionspartner component -> 12, 0, id_2573
    observation -> tgt.data as data then
    {
        observation.component as component, component.code where "code.coding.code = 'C28510'" then
        {
            component.valueString as valueString then
            {
                observation -> data.blockindex = 12;
                observation -> data.groupindex = 0;
                observation -> data.itemid     = 'id_2573';
                valueString -> data.values as values, values.value = valueString;
            };
        };
    };
    //Anzahl der Fusionsreads -> anzahl-der-fusionsreads component -> 12, 0, id_2574
    observation -> tgt.data as data then
    {
        observation.component as component then
        {
            component.valueInteger as valueInteger where "code.coding.code = '82121-5'" then
            {
                observation  -> data.blockindex = 12;
                observation  -> data.groupindex = 0;
                observation  -> data.itemid     = 'id_2574';
                valueInteger -> data.values as values, values.unit = 'count', values.value = valueInteger;
            };
        };
    };
    //3' Fusionspartner Exon -> fusionspartner-exon component -> 12, 0, id_2575
    observation -> tgt.data as data then
    {
        observation.component as component then
        {
            component.valueInteger as valueInteger where "code.coding.code = 'fusionspartner-exon'" then
            {
                observation  -> data.blockindex = 12;
                observation  -> data.groupindex = 0;
                observation  -> data.itemid     = 'id_2575';
                valueInteger -> data.values as values, values.unit = 'count', values.value = valueInteger;
            };
        };
    };
}

/* ---------------- Observation FGFR3 FusionNGS ------------------------ */
group TransformVBFSObservationFGFR3CDS(source observation: Observation, target tgt: BackboneElement)
{
    //Date Of Assesment -> 13, 0, id_2560
    observation-> tgt.data as data then
    {
        observation.effectiveDateTime as dateOfAssessment then
        {
            observation -> data.blockindex = 13;
            observation -> data.groupindex = 0;
            observation -> data.itemid     = 'id_2560';
            dateOfAssessment-> data.values as values, values.value = dateOfAssessment;
        };
    };
    //Ergebnis -> 13, 0, id_2564
    observation->tgt.data as data then
    {
        observation.valueCodeableConcept as valueCodeableConcept,
            valueCodeableConcept.coding as coding then
        {
            observation->data.blockindex = 13;
            observation->data.groupindex = 0;
            observation->data.itemid = 'id_2564';
            coding.code as code where "code = 'LA6576-8'" -> data.values as values, values.value = 'positiv';
            coding.code as code where "code = 'LA6577-6'" -> data.values as values, values.value = 'negativ';
            coding.code as code where "code = 'LA18198-4'" -> data.values as values, values.value = 'nicht auswertbar';
        };
    };
    
    //Fusionspartner -> fusionspartner component -> 13, 0, id_2565
    observation -> tgt.data as data then
    {
        observation.component as component, component.code where "code.coding.code = 'C28510'" then
        {
            component.valueString as valueString then
            {
                observation -> data.blockindex = 13;
                observation -> data.groupindex = 0;
                observation -> data.itemid     = 'id_2565';
                valueString -> data.values as values, values.value = valueString;
            };
        };
    };
    //Anzahl der Fusionsreads -> anzahl-der-fusionsreads component -> 13, 0, id_2566
    observation -> tgt.data as data then
    {
        observation.component as component then
        {
            component.valueInteger as valueInteger where "code.coding.code = '82121-5'" then
            {
                observation  -> data.blockindex = 13;
                observation  -> data.groupindex = 0;
                observation  -> data.itemid     = 'id_2566';
                valueInteger -> data.values as values, values.unit = 'count', values.value = valueInteger;
            };
        };
    };
    //3' Fusionspartner Exon -> fusionspartner-exon component -> 13, 0, id_2567
    observation -> tgt.data as data then
    {
        observation.component as component then
        {
            component.valueInteger as valueInteger where "code.coding.code = 'fusionspartner-exon'" then
            {
                observation  -> data.blockindex = 13;
                observation  -> data.groupindex = 0;
                observation  -> data.itemid     = 'id_2567';
                valueInteger -> data.values as values, values.unit = 'count', values.value = valueInteger;
            };
        };
    };
}

/* ------------- Observation Sonstiges FusionNGS ----------------------- */
group TransformVBFSObservationSonstigeCDS(source observation: Observation, target tgt: BackboneElement, target index: RepeatIndex)
{
    //Date Of Assesment -> 21, 0, id_2246
    observation-> tgt.data as data then
    {
        observation.effectiveDateTime as dateOfAssessment then
        {
            observation -> data.blockindex  = 21;
            observation -> data.groupindex  = 0;
            observation -> data.repeatindex = evaluate(index, '$this.caseIndex');
            observation -> data.itemid      = 'id_2246';
            dateOfAssessment-> data.values as values, values.value = dateOfAssessment;
        };
    };
    //Ergebnis -> 21, 0, id_2254
    observation->tgt.data as data then
    {
        observation.valueCodeableConcept as valueCodeableConcept,
            valueCodeableConcept.coding as coding then
        {
            observation->data.blockindex = 21;
            observation->data.groupindex = 0;
            observation->data.repeatindex = evaluate(index, '$this.caseIndex');
            observation->data.itemid = 'id_2254';
            coding.code as code where "code = 'LA6576-8'" -> data.values as values, values.value = 'positiv';
            coding.code as code where "code = 'LA6577-6'" -> data.values as values, values.value = 'negativ';
            coding.code as code where "code = 'LA18198-4'" -> data.values as values, values.value = 'nicht auswertbar';
        };
    };

    // Erster Fusionspartner -> 21, 0 , id_2255 if 1 (or more) components with this code
    observation where "$this.component.where(code.coding.code = '48018-6' and valueString.exists()).count() >= 1" -> tgt.data as data then
    {
        observation->data.blockindex = 21;
        observation->data.groupindex = 0;
        observation->data.repeatindex = evaluate(index, '$this.caseIndex');
        observation->data.itemid = 'id_2255';
        observation->data.values as values, values.value = evaluate(observation, '$this.component.where(code.coding.code = \'48018-6\')[0].valueString');
    };

    // Zweiter Fusionspartner -> 21, 0 , id_2256 if 2 (or more) components with this code
    observation where "$this.component.where(code.coding.code = '48018-6' and valueString.exists()).count() >= 2" -> tgt.data as data then
    {
        observation->data.blockindex = 21;
        observation->data.groupindex = 0;
        observation->data.repeatindex = evaluate(index, '$this.caseIndex');
        observation->data.itemid = 'id_2256';
        observation->data.values as values, values.value = evaluate(observation, '$this.component.where(code.coding.code = \'48018-6\')[1].valueString');
    };

    //Anzahl der Fusionsreads -> anzahl-der-fusionsreads component -> 21, 0, id_2257
    observation -> tgt.data as data then
    {
        observation.component as component then
        {
            component.valueInteger as valueInteger where "code.coding.code = '82121-5'" then
            {
                observation  -> data.blockindex  = 21;
                observation  -> data.groupindex  = 0;
                observation  -> data.repeatindex = evaluate(index, '$this.caseIndex');
                observation  -> data.itemid      = 'id_2257';
                valueInteger -> data.values as values, values.unit = 'count', values.value = valueInteger;
            };
        };
    };

    //Exon erster Fusionspartner -> exon-erster-fusionspartner component -> 21, 0, id_2258
    observation -> tgt.data as data then
    {
        observation.component as component, component.code where "code.coding.code = 'erster-fusionspartner-exon'" then
        {
            component.valueString as valueString then
            {
                observation -> data.blockindex  = 21;
                observation -> data.groupindex  = 0;
                observation -> data.repeatindex = evaluate(index, '$this.caseIndex');
                observation -> data.itemid      = 'id_2258';
                valueString -> data.values as values, values.value = valueString;
            };
        };
    };

    //Exon zweiter Fusionspartner -> exon-zweiter-fusionspartner component -> 21, 0, id_2259
    observation -> tgt.data as data then
    {
        observation.component as component, component.code where "code.coding.code = 'zweiter-fusionspartner-exon'" then
        {
            component.valueString as valueString then
            {
                observation -> data.blockindex  = 21;
                observation -> data.groupindex  = 0;
                observation -> data.repeatindex = evaluate(index, '$this.caseIndex');
                observation -> data.itemid      = 'id_2259';
                valueString -> data.values as values, values.value = valueString;
            };
        };
    };
}

/*------------------------------------------------------------------------------
                            Fast Track                                  
------------------------------------------------------------------------------*/
group TransformVBObservationFTCDS(source observation: Observation, target tgt: BackboneElement)
{
    observation where "code.coding.code = 'BRAF Exon 15'" then TransformVBFTObservationBRAFExon15CDS(observation, tgt);
    observation where "code.coding.code = 'EGFR Exon 19'" then TransformVBFTObservationEGFRExon19CDS(observation, tgt);
    observation where "code.coding.code = 'EGFR Exon 20'" then TransformVBFTObservationEGFRExon20CDS(observation, tgt);
    observation where "code.coding.code = 'EGFR Exon 21'" then TransformVBFTObservationEGFRExon21CDS(observation, tgt);
    observation where "code.coding.code = 'KRAS Exon 2'" then TransformVBFTObservationKRASExon2CDS(observation, tgt);
}

/* ------------ Observation BRAF Exon 15 Fast Track -------------------- */
group TransformVBFTObservationBRAFExon15CDS(source observation: Observation, target tgt: BackboneElement)
{
    //Date Of Assesment -> 22, 0, id_1945
    observation-> tgt.data as data then
    {
        observation.effectiveDateTime as effectiveDateTime then
        {
            observation -> data.blockindex = 22;
            observation -> data.groupindex = 0;
            observation -> data.itemid     = 'id_1945';
            effectiveDateTime -> data.values as values, values.value = effectiveDateTime;
        };
    };
    //Ergebnis -> 22, 0, id_1946
    
    observation -> tgt.data as data then
    {
        observation.valueCodeableConcept as valueCodeableConcept,
            valueCodeableConcept.coding as coding,
            coding.code as code then
        {
            observation -> data.blockindex = 22;
            observation -> data.groupindex = 0;
            observation -> data.itemid     = 'id_1946';
                    code -> data.values as values, values.value = code;
        };
    };
    //Change DNA -> dna-chg component -> 22, 0, id_1947
    observation -> tgt.data as data then
    {
        observation.component as component, 
        component.code where "code.coding.code = '48004-6'" then
        {
            component.valueString as valueString then
            {
                observation -> data.blockindex = 22;
                observation -> data.groupindex = 0;
                observation -> data.itemid     = 'id_1947';
                valueString -> data.values as values, values.value = valueString;
            };
        };
    };
    //Change Protein -> amino-acid-chg component -> 22, 0, id_1948
    observation -> tgt.data as data then
    {
        observation.component as component, 
        component.code where "code.coding.code = '48005-3'" then
        {
            component.valueString as valueString then
            {
                observation -> data.blockindex  = 22;
                observation -> data.groupindex  = 0;
                observation -> data.itemid      = 'id_1948';
                valueString -> data.values as values, values.value = valueString;
            };
        };
    };
}

/* ------------ Observation BRAF Exon 19 Fast Track -------------------- */
group TransformVBFTObservationEGFRExon19CDS(source observation: Observation, target tgt: BackboneElement)
{
    // Date of Assessment  -> 23, 0, ft_grp_egfr_19-21
    // Assay -> assay component -> 23, 0, id_2608
    // Hersteller -> hersteller -> 23, 0, id_2609
    //these three items shown before were mapped in the following group
    observation then TransformObservationVBFTDateAssayHerstellerEGFREXO1921(observation, tgt);

    //Ergebnis -> 23, 0, id_1950
    observation -> tgt.data as data then
    {
        observation.valueCodeableConcept as valueCodeableConcept,
            valueCodeableConcept.coding as coding,
            coding.code as code then
        {
            observation -> data.blockindex = 23;
            observation -> data.groupindex = 0;
            observation -> data.itemid     = 'id_1950';
                    code -> data.values as values, values.value = code;
        };
    };
    //Change DNA -> dna-chg component -> 23, 0, id_1951
    observation -> tgt.data as data then
    {
        observation.component as component, 
        component.code where "code.coding.code = '48004-6'" then
        {
            component.valueString as valueString then
            {
                observation -> data.blockindex = 23;
                observation -> data.groupindex = 0;
                observation -> data.itemid     = 'id_1951';
                valueString -> data.values as values, values.value = valueString;
            };
        };
    };
    //Change Protein -> amino-acid-chg component -> 23, 0, id_1952
    observation -> tgt.data as data then
    {
        observation.component as component, 
        component.code where "code.coding.code = '48005-3'" then
        {
            component.valueString as valueString then
            {
                observation -> data.blockindex  = 23;
                observation -> data.groupindex  = 0;
                observation -> data.itemid      = 'id_1952';
                valueString -> data.values as values, values.value = valueString;
            };
        };
    };
}

/* ------------ Observation BRAF Exon 20 Fast Track -------------------- */
group TransformVBFTObservationEGFRExon20CDS(source observation: Observation, target tgt: BackboneElement)
{
    // Date of Assessment  -> 23, 0, ft_grp_egfr_19-21
    // Assay -> assay component -> 23, 0, id_2608
    // Hersteller -> hersteller -> 23, 0, id_2609
    //these three items shown before were mapped in the following group
    observation then TransformObservationVBFTDateAssayHerstellerEGFREXO1921(observation, tgt);

    //Ergebnis -> 23, 0, id_1954
    observation -> tgt.data as data then
    {
        observation.valueCodeableConcept as valueCodeableConcept,
            valueCodeableConcept.coding as coding,
            coding.code as code then
        {
            observation -> data.blockindex = 23;
            observation -> data.groupindex = 0;
            observation -> data.itemid     = 'id_1954';
            code -> data.values as values, values.value = code;
        };
    };
    //Change DNA -> dna-chg component -> 23, 0, id_1955
    observation -> tgt.data as data then
    {
        observation.component as component, 
        component.code where "code.coding.code = '48004-6'" then
        {
            component.valueString as valueString then
            {
                observation -> data.blockindex = 23;
                observation -> data.groupindex = 0;
                observation -> data.itemid     = 'id_1955';
                valueString -> data.values as values, values.value = valueString;
            };
        };
    };
    //Change Protein -> amino-acid-chg component -> 23, 0, id_1956
    observation -> tgt.data as data then
    {
        observation.component as component, 
        component.code where "code.coding.code = '48005-3'" then
        {
            component.valueString as valueString then
            {
                observation -> data.blockindex  = 23;
                observation -> data.groupindex  = 0;
                observation -> data.itemid      = 'id_1956';
                valueString -> data.values as values, values.value = valueString;
            };
        };
    };
}

/* ------------ Observation BRAF Exon 21 Fast Track -------------------- */
group TransformVBFTObservationEGFRExon21CDS(source observation: Observation, target tgt: BackboneElement)
{
    // Date of Assessment  -> 23, 0, ft_grp_egfr_19-21
    // Assay -> assay component -> 23, 0, id_2608
    // Hersteller -> hersteller -> 23, 0, id_2609
    //these three items shown before were mapped in the following group
    observation then TransformObservationVBFTDateAssayHerstellerEGFREXO1921(observation, tgt);

    //Ergebnis -> 23, 0, id_1958
    observation -> tgt.data as data then
    {
        observation.valueCodeableConcept as valueCodeableConcept,
            valueCodeableConcept.coding as coding,
            coding.code as code then
        {
            observation -> data.blockindex = 23;
            observation -> data.groupindex = 0;
            observation -> data.itemid     = 'id_1958';
            code -> data.values as values, values.value = code;
        };
    };
    //Change DNA -> dna-chg component -> 23, 0, id_1959
    observation -> tgt.data as data then
    {
        observation.component as component, 
        component.code where "code.coding.code = '48004-6'" then
        {
            component.valueString as valueString then
            {
                observation -> data.blockindex = 23;
                observation -> data.groupindex = 0;
                observation -> data.itemid     = 'id_1959';
                valueString -> data.values as values, values.value = valueString;
            };
        };
    };
    //Change Protein -> amino-acid-chg component -> 23, 0, id_1960
    observation -> tgt.data as data then
    {
        observation.component as component, 
        component.code where "code.coding.code = '48005-3'" then
        {
            component.valueString as valueString then
            {
                observation -> data.blockindex  = 23;
                observation -> data.groupindex  = 0;
                observation -> data.itemid      = 'id_1960';
                valueString -> data.values as values, values.value = valueString;
            };
        };
    };
}

/* ------------ Observation KRAS Exon 2 Fast Track -------------------- */
group TransformVBFTObservationKRASExon2CDS(source observation: Observation, target tgt: BackboneElement)
{
    //Date Of Assesment -> 24, 0, id_1961
    observation-> tgt.data as data then
    {
        observation.effectiveDateTime as effectiveDateTime then
        {
            observation -> data.blockindex = 24;
            observation -> data.groupindex = 0;
            observation -> data.itemid     = 'id_1961';
            effectiveDateTime -> data.values as values, values.value = effectiveDateTime;
        };
    };

    //Ergebnis -> 24, 0, id_1962
    observation -> tgt.data as data then
    {
        observation.valueCodeableConcept as valueCodeableConcept,
            valueCodeableConcept.coding as coding,
            coding.code as code then
        {
            observation -> data.blockindex = 24;
            observation -> data.groupindex = 0;
            observation -> data.itemid     = 'id_1962';
            code -> data.values as values, values.value = code;
        };
    };
    //Change DNA -> dna-chg component -> 24, 0, id_1963
    observation -> tgt.data as data then
    {
        observation.component as component, 
        component.code where "code.coding.code = '48004-6'" then
        {
            component.valueString as valueString then
            {
                observation -> data.blockindex = 24;
                observation -> data.groupindex = 0;
                observation -> data.itemid     = 'id_1963';
                valueString -> data.values as values, values.value = valueString;
            };
        };
    };
    //Change Protein -> amino-acid-chg component -> 24, 0, id_1964
    observation -> tgt.data as data then
    {
        observation.component as component, 
        component.code where "code.coding.code = '48005-3'" then
        {
            component.valueString as valueString then
            {
                observation -> data.blockindex  = 24;
                observation -> data.groupindex  = 0;
                observation -> data.itemid      = 'id_1964';
                valueString -> data.values as values, values.value = valueString;
            };
        };
    };
}

/*------------------------------------------------------------------------------
                            NGS Panel                                  
------------------------------------------------------------------------------*/
/* ----------------------- Observation NGS Panel ---------------------- */
group TransformVBObservationLPCDS(source observation: Observation, target tgt: BackboneElement, target index: RepeatIndex)
{
    //Date Of Assesment -> 26, 0, 0, id_1160
    observation-> tgt.data as data then
    {
        observation.effectiveDateTime as effectiveDateTime then
        {
            observation -> data.blockindex  = 26;
            observation -> data.groupindex  = 0;
            observation -> data.repeatindex = evaluate(index, '$this.sectionIndex');
            observation -> data.itemid      = 'id_1160';
            effectiveDateTime -> data.values as values, values.value = effectiveDateTime;
        };
    };
    //Gen -> gene-studied -> 26, 0, id_1159
    observation -> tgt.data as data then
    {
        observation.component as component, component.code where "code.coding.code = '48018-6'" then
        {
            component.valueCodeableConcept as valueCodeableConcept,
            valueCodeableConcept.coding as coding, coding.code as code  then
            {
                observation -> data.blockindex  = 26;
                observation -> data.groupindex  = 0;
                observation -> data.repeatindex = evaluate(index, '$this.sectionIndex');
                observation -> data.itemid      = 'id_1159';
                    code   -> data.values as values, values.value = code;
            };
        };
    };
    //Exon -> exon -> 26, 0, 0, id_35
    observation -> tgt.data as data then
    {
        observation.component as component then
        {
            component.valueString as valueString where "code.coding.code = 'C13231'" then
            {
                observation  -> data.blockindex  = 26;
                observation  -> data.groupindex  = 0;
                observation  -> data.repeatindex = evaluate(index, '$this.sectionIndex');
                observation  -> data.itemid      = 'id_35';
                valueString  -> data.values as values, values.value = valueString;
            };
        };
    };

    //HGVS c. (Mutation cDNA) -> dna-chg -> 26, 0, 0, id_36
    observation -> tgt.data as data then
    {
        observation.component as component then
        {
            component.valueString as valueString where "code.coding.code = '48004-6'" then
            {
                observation  -> data.blockindex  = 26;
                observation  -> data.groupindex  = 0;
                observation  -> data.repeatindex = evaluate(index, '$this.sectionIndex');
                observation  -> data.itemid      = 'id_36';
                valueString  -> data.values as values, values.value = valueString;
            };
        };
    };
    //HGVS p. (Mutation Protein) -> 26, 0, 0, id_37
    observation -> tgt.data as data then
    {
        observation.component as component then
        {
            component.valueString as valueString where "code.coding.code = '48005-3'" then
            {
                observation  -> data.blockindex  = 26;
                observation  -> data.groupindex  = 0;
                observation  -> data.repeatindex = evaluate(index, '$this.sectionIndex');
                observation  -> data.itemid      = 'id_37';
                valueString  -> data.values as values, values.value = valueString;
            };
        };
    };
    //Allelic fraction -> allelicfraction  -> 26, 0, 0, id_38
    observation -> tgt.data as data then
    {
        observation.component as component then
        {
            component.valueQuantity as quantity where "code.coding.code = 'C154665'" then
            {
                observation -> data.blockindex  = 26;
                observation -> data.groupindex  = 0;
                observation -> data.repeatindex = evaluate(index, '$this.sectionIndex');
                observation -> data.itemid      = 'id_38';
                quantity.value as value ->data.values as values, values.unit = 'percent', values.value = value;
            };
        };
    };
    //Referenztranskript -> referenztranskript -> 26, 0, 0, ngs_panel_reftranscript
    observation -> tgt.data as data then
    {
        observation.component as component then
        {
            component.valueString as valueString where "code.coding.code = '51958-7'" then
            {
                observation  -> data.blockindex  = 26;
                observation  -> data.groupindex  = 0;
                observation  -> data.repeatindex = evaluate(index, '$this.sectionIndex');
                observation  -> data.itemid      = 'ngs_panel_reftranscript';
                valueString  -> data.values as values, values.value = valueString;
            };
        };
    };
    //Coverage -> coverage -> 26, 0, 0, ngs_panel_coverage
    observation -> tgt.data as data then
    {
        observation.component as component then
        {
            component.valueString as valueString where "code.coding.code = '82121-5'" then
            {
                observation  -> data.blockindex  = 26;
                observation  -> data.groupindex  = 0;
                observation  -> data.repeatindex = evaluate(index, '$this.sectionIndex');
                observation  -> data.itemid      = 'ngs_panel_coverage';
                valueString  -> data.values as values, values.value = valueString;
            };
        };
    };
    //Biologische/molekulare Bewertung  -> 26, 0, 0, id_47
    observation -> tgt.data as data then
    {
        observation.interpretation as interpretation,
            interpretation.coding as coding,
            coding.code as code then
            {
                observation -> data.blockindex  = 26;
                observation -> data.groupindex  = 0;
                observation -> data.repeatindex = evaluate(index, '$this.sectionIndex');
                observation -> data.itemid      = 'id_47';
                    code -> data.values as values, values.value = code;
            };
    };
    //Kommentar -> 26, 0, 0, id_48
    observation -> tgt.data as data then
    {
        observation.note as note, note.text as text then
        {
            observation -> data.blockindex  = 26;
            observation -> data.groupindex  = 0;
            observation -> data.repeatindex = evaluate(index, '$this.sectionIndex');
            observation -> data.itemid      = 'id_48';
                    text -> data.values as values, values.value = text;
        };
    };
}

/* --------------------- Device NGSPanel Fusion NGS -------------------- */
group TransformVBDeviceLPCDS(source device: Device, target tgt: BackboneElement)
{
    //NGS Lung Panel Version -> 25, 0, id_1260
    device -> tgt.data as data then
    {
        device.version as version, version.value as value then
        {
            device -> data.blockindex = 25;
            device -> data.groupindex = 0;
            device -> data.itemid     = 'id_1260';
            value  -> data.values as values, values.value = value;
        };
    };
}

/*------------------------------------------------------------------------------
                             HELPERS                                   
------------------------------------------------------------------------------*/
group TransformationObservationALKDatePhanotypVorbefund(source observation:Observation, target tgt: BackboneElement)
{
    //Date Of Assesment -> 3, 0, id_2098
    observation-> tgt.data as data then
    {
        observation.effectiveDateTime as edt where "code.coding.code = 'ALK' and %tgt.data.where(itemid = 'id_2098').exists().not()" then
        {
            observation -> data.blockindex   = 3;
            observation -> data.groupindex   = 0;
            observation -> data.itemid       = 'id_2098';
            edt-> data.values as values, values.value = edt;
        };
    };
    
    //Phänotyp: phanotyp component-> 3, 0, id_2099
    observation -> tgt.data as data then
    {
        observation.component as component, component.code where "code.coding.code = 'C16977'" then
        {
            component.valueCodeableConcept as vcc where "%tgt.data.where(itemid = 'id_2099').exists().not()" then
            {
                observation -> data.blockindex = 3;
                observation -> data.groupindex = 0;
                observation -> data.itemid     = 'id_2099';
                vcc.coding as coding where "coding.code = 'C80488'"->data.values as values, values.unit = 'predef', values.value = 'Expression';
                vcc.coding as coding where "coding.code = 'C28510'"->data.values as values, values.unit = 'predef', values.value = 'Fusion';
                vcc.coding as coding where "coding.code = 'C25418'"->data.values as values, values.unit = 'predef', values.value = 'Amplifikation';
            };
        };
    };
}

group TransformationObservationMETDatePhanotypVorbefund(source observation:Observation, target tgt: BackboneElement)
{
    //Date Of Assesment -> 6, 0, id_2132
    observation-> tgt.data as data then
    {
        observation.effectiveDateTime as edt where "code.coding.code = 'MET' and %tgt.data.where(itemid = 'id_2132').exists().not()" then
        {
            observation -> data.blockindex = 6;
            observation -> data.groupindex = 0;
            observation -> data.itemid     = 'id_2132';
            edt-> data.values as values, values.value = edt;
        };
    };

    //Phänotyp: phanotyp component-> 6, 0, id_2133
    observation -> tgt.data as data then
    {
        observation.component as component, component.code where "code.coding.code = 'C16977'" then
        {
            component.valueCodeableConcept as vcc where "%tgt.data.where(itemid = 'id_2133').exists().not()" then
            {
                observation -> data.blockindex = 6;
                observation -> data.groupindex = 0;
                observation -> data.itemid     = 'id_2133';
                vcc.coding as coding where "coding.code = 'C80488'"->data.values as values, values.unit = 'predef', values.value = 'Expression';
                vcc.coding as coding where "coding.code = 'C28510'"->data.values as values, values.unit = 'predef', values.value = 'Fusion';
                vcc.coding as coding where "coding.code = 'C25418'"->data.values as values, values.unit = 'predef', values.value = 'Amplifikation';
            };
        };
    };
}

group TransformationObservationROS1DatePhanotypVorbefund(source observation:Observation, target tgt: BackboneElement)
{
    //Date Of Assesment -> 17, 0, id_2211
    observation-> tgt.data as data then
    {
        observation.effectiveDateTime as edt where "code.coding.code = 'ROS1' and %tgt.data.where(itemid = 'id_2211').exists().not()" then
        {
            observation -> data.blockindex = 17;
            observation -> data.groupindex = 0;
            observation -> data.itemid     = 'id_2211';
            edt-> data.values as values, values.value = edt;
        };
    };

    //Phänotyp: phanotyp component-> 17, 0, id_2212
    observation -> tgt.data as data then
    {
        observation.component as component, component.code where "code.coding.code = 'C16977'" then
        {
            component.valueCodeableConcept as vcc where "%tgt.data.where(itemid = 'id_2212').exists().not()" then
            {
                observation -> data.blockindex = 17;
                observation -> data.groupindex = 0;
                observation -> data.itemid     = 'id_2212';
                vcc.coding as coding where "coding.code = 'C80488'"->data.values as values, values.unit = 'predef', values.value = 'Expression';
                vcc.coding as coding where "coding.code = 'C28510'"->data.values as values, values.unit = 'predef', values.value = 'Fusion';
                vcc.coding as coding where "coding.code = 'C25418'"->data.values as values, values.unit = 'predef', values.value = 'Amplifikation';
            };
        };
    };
}

group TransformationObservationRETDatePhanotypVorbefund(source observation:Observation, target tgt: BackboneElement)
{
     //Date Of Assesment -> 20, 0, id_2183
    observation-> tgt.data as data then
    {
        observation.effectiveDateTime as edt where "code.coding.code = 'RET' and %tgt.data.where(itemid = 'id_2183').exists().not()" then
        {
            observation -> data.blockindex = 20;
            observation -> data.groupindex = 0;
            observation -> data.itemid     = 'id_2183';
            edt-> data.values as values, values.value = edt;
        };
    };

    //Phänotyp: phanotyp component-> 20, 0, id_2184
    observation -> tgt.data as data then
    {
        observation.component as component, component.code where "code.coding.code = 'C16977'" then
        {
            component.valueCodeableConcept as vcc where "%tgt.data.where(itemid = 'id_2184').exists().not()" then
            {
                observation -> data.blockindex = 20;
                observation -> data.groupindex = 0;
                observation -> data.itemid     = 'id_2184';
                vcc.coding as coding where "coding.code = 'C80488'"->data.values as values, values.unit = 'predef', values.value = 'Expression';
                vcc.coding as coding where "coding.code = 'C28510'"->data.values as values, values.unit = 'predef', values.value = 'Fusion';
                vcc.coding as coding where "coding.code = 'C25418'"->data.values as values, values.unit = 'predef', values.value = 'Amplifikation';
            };
        };
    };
}

group TransformObservationVBFTDateAssayHerstellerEGFREXO1921(source observation:Observation, target tgt: BackboneElement)
{
    //Date Of Assesment -> 23, 0, ft_grp_egfr_19-21
    observation-> tgt.data as data then
    {
        observation.effectiveDateTime as effectiveDateTime where "%tgt.data.where(itemid = 'ft_grp_egfr_19-21').exists().not()" then
        {
            observation -> data.blockindex   = 23;
            observation -> data.groupindex   = 0;
            observation -> data.itemid       = 'ft_grp_egfr_19-21';
            effectiveDateTime -> data.values as values, values.value = effectiveDateTime;
        };
    };
    //Assay -> assay component -> 23, 0, id_2608
    observation -> tgt.data as data then
    {
        observation.component as component, component.code where "code.coding.code = 'C60819'" then
        {
            component.valueCodeableConcept as valueCodeableConcept,
            valueCodeableConcept.coding as coding, 
            coding.code as code where "%tgt.data.where(itemid = 'id_2608').exists().not()" then
            {
                observation -> data.blockindex = 23;
                observation -> data.groupindex = 0;
                observation -> data.itemid     = 'id_2608';
                code -> data.values as values, values.value = code;
            };
        };
    };
    // Hersteller -> hersteller component -> 23, 0, id_2609
    observation -> tgt.data as data then
    {
        observation.component as component, 
        component.code where "code.coding.code = 'C25392'" then
        {
            component.valueCodeableConcept as valueCodeableConcept,
            valueCodeableConcept.coding as coding, 
            coding.code as code where "%tgt.data.where(itemid = 'id_2609').exists().not()" then
            {
                observation -> data.blockindex = 23;
                observation -> data.groupindex = 0;
                observation -> data.itemid     = 'id_2609';
                code -> data.values as values, values.value = code;
            };
        };
    };
}