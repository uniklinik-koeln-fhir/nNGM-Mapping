/// version = 0.1
/// title = "nNGM: nNGM_Mapping_Immunhistochemie_checkboxesCTS - FHIR to CTS"

map "http://uk-koeln.de/fhir/StructureMap/nNGM_Mapping_Immunhistochemie_checkboxesCTS" = nNGM_Mapping_Immunhistochemie_checkboxesCTS

uses "http://hl7.org/fhir/StructureDefinition/Bundle" as source
uses "http://hl7.org/fhir/StructureDefinition/CTS_Transport" as target

group TransformImmunhistochemieCheckboxes(source src: Bundle, target tgt: BackboneElement)
{
    src.entry as entry then
    {
        entry.resource as observation where "resource is Observation 
                                            and resource.code.coding.code = 'CK7'
                                            and resource.category.coding.where(system = \'http://uk-koeln.de/fhir/ValueSet/obs-methods\').code = 'IHC'" then
        {
            observation -> tgt.data as data collate then
            {
                observation.status as status where "%tgt.data.where(itemid = 'id_2508').exists().not()" then
                {
                    observation -> data.blockindex = 3;
                    observation -> data.groupindex = 0;
                    observation -> data.itemid = 'id_2508';
                };
                observation -> data.values as values, values.value = 'CK7';
            };
        };

        entry.resource as observation where "resource is Observation 
                                            and resource.code.coding.code = 'P40'
                                            and resource.category.coding.where(system = \'http://uk-koeln.de/fhir/ValueSet/obs-methods\').code = 'IHC'" then
        {
            observation -> tgt.data as data collate then
            {
                observation.status as status where "%tgt.data.where(itemid = 'id_2508').exists().not()" then
                {
                    observation -> data.blockindex = 3;
                    observation -> data.groupindex = 0;
                    observation -> data.itemid = 'id_2508';
                };
                observation -> data.values as values, values.value = 'P40';
            };
        };

        entry.resource as observation where "resource is Observation 
                                            and resource.code.coding.code = 'TTF1'
                                            and resource.category.coding.where(system = \'http://uk-koeln.de/fhir/ValueSet/obs-methods\').code = 'IHC'" then
        {
            observation -> tgt.data as data collate then
            {
                observation.status as status where "%tgt.data.where(itemid = 'id_2508').exists().not()" then
                {
                    observation -> data.blockindex = 3;
                    observation -> data.groupindex = 0;
                    observation -> data.itemid = 'id_2508';
                };
                observation -> data.values as values, values.value = 'TTF1';
            };
        };

        entry.resource as observation where "resource is Observation 
                                            and resource.code.coding.code = 'ALK'
                                            and resource.category.coding.where(system = \'http://uk-koeln.de/fhir/ValueSet/obs-methods\').code = 'IHC'" then
        {
            observation -> tgt.data as data collate then
            {
                observation.status as status where "%tgt.data.where(itemid = 'id_2508').exists().not()" then
                {
                    observation -> data.blockindex = 3;
                    observation -> data.groupindex = 0;
                    observation -> data.itemid = 'id_2508';
                };
                observation -> data.values as values, values.value = 'ALK';
            };
        };

        entry.resource as observation where "resource is Observation 
                                            and resource.code.coding.code = 'PD-L1'
                                            and resource.category.coding.where(system = \'http://uk-koeln.de/fhir/ValueSet/obs-methods\').code = 'IHC'" then
        {
            observation -> tgt.data as data collate then
            {
                observation.status as status where "%tgt.data.where(itemid = 'id_2508').exists().not()" then
                {
                    observation -> data.blockindex = 3;
                    observation -> data.groupindex = 0;
                    observation -> data.itemid = 'id_2508';
                };
                observation -> data.values as values, values.value = 'PD-L1';
            };
        };

        entry.resource as observation where "resource is Observation 
                                            and resource.code.coding.code = 'ROS1'
                                            and resource.category.coding.where(system = \'http://uk-koeln.de/fhir/ValueSet/obs-methods\').code = 'IHC'" then
        {
            observation -> tgt.data as data collate then
            {
                observation.status as status where "%tgt.data.where(itemid = 'id_2508').exists().not()" then
                {
                    observation -> data.blockindex = 3;
                    observation -> data.groupindex = 0;
                    observation -> data.itemid = 'id_2508';
                };
                observation -> data.values as values, values.value = 'ROS1';
            };
        };
    };
}