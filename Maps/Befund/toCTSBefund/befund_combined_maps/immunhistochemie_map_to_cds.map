/// version = 0.1
/// title = "nNGM: nNGM_Mapping_ImmunhistochemieCTS - FHIR to CTS"

map "http://uk-koeln.de/fhir/StructureMap/nNGM_Mapping_ImmunhistochemieCTS" = nNGM_Mapping_ImmunhistochemieCTS

uses "http://hl7.org/fhir/StructureDefinition/Bundle" as source
uses "http://hl7.org/fhir/StructureDefinition/CTS_Transport" as target

group TransformImmunhistochemieOperation(source src: Bundle, target tgt: BackboneElement)
{
    src -> tgt.type = 'save';
    src -> tgt.crfid = '1-IHC1';
 
    src.entry as entry then
    {
        /*---------------Episode Of Care----------------*/
        entry.resource as episodeofcare where "resource is EpisodeOfCare and resource.id = 'd2c46c91-fc7a-4a5d-9791-995f68c1bdc1'" then
        {
            //Untersuchung-ID
            episodeofcare -> tgt.data as data then
            {
                episodeofcare.identifier as identifier, identifier.value as value then
                {   
                    episodeofcare -> data.blockindex = 1;
                    episodeofcare -> data.groupindex = 0;
                    episodeofcare -> data.itemid = 'assessment_id';
                    value -> data.values as values, values.value = value;
                };
            };
        };

        /*---------------Organization----------------*/
        entry.resource as organization where "resource is Organization" then
        {
            //Standort
            organization -> tgt.data as data then
            {
                organization.name as name then
                {   
                    organization -> data.blockindex = 0;
                    organization -> data.groupindex = 0;
                    organization -> data.itemid = 'id_2435';
                    name -> data.values as values, values.value = name;
                };
            };
        };

        /*-----------------------CK7 Oberservation----------------------*/
        entry.resource as observation where "resource is Observation 
                                            and resource.code.coding.code = 'CK7' 
                                            and resource.category.coding.where(system = \'http://uk-koeln.de/fhir/ValueSet/obs-methods\').code = 'IHC'" then
        {
             //Date Of Assesment
            observation -> tgt.data as data then
            {
                observation.effectivePeriod as period then
                {   
                    observation -> data.blockindex = 5;
                    observation -> data.groupindex = 0;
                    observation -> data.itemid = 'id_2037';
                    period.start as dateOfAssessment -> data.values as values, values.value = dateOfAssessment;
                };
            };

            //Ergebnis
            observation -> tgt.data as data then
            {
                observation.valueCodeableConcept as cc, cc.coding as coding then
                {
                    observation -> data.blockindex = 5;
                    observation -> data.groupindex = 0;
                    observation -> data.itemid = 'id_2045';
                    coding.code as code -> data.values as values, values.value = code;
                };
            };
        };

        /*-----------------------P40 Oberservation----------------------*/
        entry.resource as observation where "resource is Observation 
                                            and resource.code.coding.code = 'P40' 
                                            and resource.category.coding.where(system = \'http://uk-koeln.de/fhir/ValueSet/obs-methods\').code = 'IHC'" then
        {
             //Date Of Assesment
            observation -> tgt.data as data then
            {
                observation.effectivePeriod as period then
                {   
                    observation -> data.blockindex = 8;
                    observation -> data.groupindex = 0;
                    observation -> data.itemid = 'id_2073';
                    period.start as dateOfAssessment -> data.values as values, values.value = dateOfAssessment;
                };
            };

            //Ergebnis
            observation -> tgt.data as data then
            {
                observation.valueCodeableConcept as cc, cc.coding as coding then
                {
                    observation -> data.blockindex = 8;
                    observation -> data.groupindex = 0;
                    observation -> data.itemid = 'id_2079';
                    coding.code as code -> data.values as values, values.value = code;
                };
            };
        };

        /*-----------------------TTF1 Oberservation----------------------*/
        entry.resource as observation where "resource is Observation 
                                            and resource.code.coding.code = 'TTF1' 
                                            and resource.category.coding.where(system = \'http://uk-koeln.de/fhir/ValueSet/obs-methods\').code = 'IHC'" then
        {
             //Date Of Assesment
            observation -> tgt.data as data then
            {
                observation.effectivePeriod as period then
                {   
                    observation -> data.blockindex = 10;
                    observation -> data.groupindex = 0;
                    observation -> data.itemid = 'id_2089';
                    period.start as dateOfAssessment -> data.values as values, values.value = dateOfAssessment;
                };
            };

            //Ergebnis
            observation -> tgt.data as data then
            {
                observation.valueCodeableConcept as cc, cc.coding as coding then
                {
                    observation -> data.blockindex = 10;
                    observation -> data.groupindex = 0;
                    observation -> data.itemid = 'id_2097';
                    coding.code as code -> data.values as values, values.value = code;
                };
            };
        };

        /*-----------------------ALK Oberservation----------------------*/
        entry.resource as observation where "resource is Observation 
                                            and resource.code.coding.code = 'ALK' 
                                            and resource.category.coding.where(system = \'http://uk-koeln.de/fhir/ValueSet/obs-methods\').code = 'IHC'" then
        {
             //Date Of Assesment
            observation -> tgt.data as data then
            {
                observation.effectivePeriod as period then
                {   
                    observation -> data.blockindex = 11;
                    observation -> data.groupindex = 0;
                    observation -> data.itemid = 'id_2098';
                    period.start as dateOfAssessment -> data.values as values, values.value = dateOfAssessment;
                };
            };

            //Ergebnis
            observation -> tgt.data as data then
            {
                observation.valueCodeableConcept as cc, cc.coding as coding then
                {
                    observation -> data.blockindex = 11;
                    observation -> data.groupindex = 0;
                    observation -> data.itemid = 'id_2106';
                    coding.code as code -> data.values as values, values.value = code;
                };
            };
        };

        /*-----------------------PD-L1 Oberservation----------------------*/
        entry.resource as observation where "resource is Observation 
                                            and resource.code.coding.code = 'PD-L1' 
                                            and resource.category.coding.where(system = \'http://uk-koeln.de/fhir/ValueSet/obs-methods\').code = 'IHC'" then
        {
             //Date Of Assesment
            observation -> tgt.data as data then
            {
                observation.effectivePeriod as period then
                {   
                    observation -> data.blockindex = 13;
                    observation -> data.groupindex = 0;
                    observation -> data.itemid = 'id_2172';
                    period.start as dateOfAssessment -> data.values as values, values.value = dateOfAssessment;
                };
            };

            //Ergebnis
            observation -> tgt.data as data then
            {
                observation.valueCodeableConcept as cc, cc.coding as coding then
                {
                    observation -> data.blockindex = 13;
                    observation -> data.groupindex = 0;
                    observation -> data.itemid = 'id_2180';
                    coding.code as code -> data.values as values, values.value = code;
                };
            };

            //Positive Tumorzellen
            observation -> tgt.data as data then
            {
                observation.component as component then
                {   
                    component.valueQuantity as quantity where "code.coding.code = 'C70460' and code.coding.system = 'http://ncit.nci.nih.gov'" then
                    {
                        observation -> data.blockindex = 13;
                        observation -> data.groupindex = 0;
                        observation -> data.itemid = 'id_2181';
                        quantity.value as value -> data.values as values, values.unit = 'percent', values.value = value;
                    };
                };
            };
        };

        /*-----------------------ROS1 Oberservation----------------------*/
        entry.resource as observation where "resource is Observation 
                                            and resource.code.coding.code = 'ROS1' 
                                            and resource.category.coding.where(system = \'http://uk-koeln.de/fhir/ValueSet/obs-methods\').code = 'IHC'" then
        {
            //Date Of Assesment
            observation -> tgt.data as data then
            {
                observation.effectivePeriod as period then
                {   
                    observation -> data.blockindex = 14;
                    observation -> data.groupindex = 0;
                    observation -> data.itemid = 'id_2211';
                    period.start as dateOfAssessment -> data.values as values, values.value = dateOfAssessment;
                };
            };

            //Ergebnis
            observation -> tgt.data as data then
            {
                observation.valueCodeableConcept as cc, cc.coding as coding then
                {
                    observation -> data.blockindex = 14;
                    observation -> data.groupindex = 0;
                    observation -> data.itemid = 'id_2219';
                    coding.code as code -> data.values as values, values.value = code;
                };
            };
        };

        /*------------------ServiceRequest----------------------*/
        entry.resource as servicerequest where "resource is ServiceRequest and resource.status = 'final'" then
        {
            //DurchfÃ¼hrung
            servicerequest -> tgt.data as data then
            {
                servicerequest.status as status then
                {   
                    servicerequest -> data.blockindex = 15;
                    servicerequest -> data.groupindex = 0;
                    servicerequest -> data.itemid = 'id_2520';
                    servicerequest -> data.values as values, values.value = 'abgeschlossen';
                };
            };
        };
    };
}
