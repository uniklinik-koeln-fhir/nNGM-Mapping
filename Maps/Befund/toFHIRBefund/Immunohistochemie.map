/// version = 0.1
/// title = "Immunohistochemie"
/* TO do

*/

map "http://uk-koeln.de/fhir/StructureMap/ImmunohistochemieFHIR" = ImmunohistochemieFHIR

uses "http://hl7.org/fhir/StructureDefinition/CTS_Transport" as source
uses "http://hl7.org/fhir/StructureDefinition/EpisodeOfCare" as target
uses "http://hl7.org/fhir/StructureDefinition/Organization" as target
uses "http://hl7.org/fhir/StructureDefinition/Observation" as target
uses "http://hl7.org/fhir/StructureDefinition/ServiceRequest" as target

group TransformBundle(source src: CTS_Transport, target bundle: Bundle)
{
    src -> bundle.id = uuid();
    src -> bundle.type = 'collection';

    src -> bundle.entry as entry then CreateTransformEpisodeOfCareIHC(src, entry);
    src -> bundle.entry as entry then CreateTransformObservationIHC(src, entry);
    src -> bundle.entry as entry then CreateTransformOrganizationIHC(src, entry);
    src -> bundle.entry as entry then CreateTransformServiceRequestIHC(src, entry);
}

group CreateTransformEpisodeOfCareIHC(source src: CTS_Transport, target tgt: BackboneElement)
{
    src.operations as operations, operations.data as data then
    {
        data.values as values where "blockindex = 1 and groupindex = 0 and itemid = 'assessment_id'" then
        {
            src -> tgt.resource = create('EpisodeOfCare') as episodeofcare then TransformEpisodeOfCareIHC(src, episodeofcare);
        };
    };
}

group CreateTransformOrganizationIHC(source src: CTS_Transport, target tgt: BackboneElement)
{
    src.operations as operations, operations.data as data then
    {
        data.values as values where "blockindex = 2 and groupindex = 0 and itemid = 'id_2435'
        or blockindex = 2 and groupindex = 0 and itemid = 'id_2613'" then
        {
            src -> tgt.resource = create('Organization') as organization then TransformOrganizationIHC(src, organization);
        };
    };
}


group CreateTransformObservationIHC(source src: CTS_Transport, target tgt: BackboneElement)
{
    src.operations as operations, operations.data as data then
    {
        data.values as values where "blockindex = 3 and groupindex = 0 and itemid = 'id_2508'
        or blockindex = 4 and groupindex = 0 and itemid = 'braf_ihc_group'
        or blockindex = 4 and groupindex = 0 and itemid = 'braf_ihc_phaenotype'
        or blockindex = 4 and groupindex = 0 and itemid = 'braf_ihc_ab'
        or blockindex = 4 and groupindex = 0 and itemid = 'braf_ihc_ab_producer'
        or blockindex = 4 and groupindex = 0 and itemid = 'braf_ihc_result' 
        or blockindex = 5 and groupindex = 0 and itemid = 'id_2037'
        or blockindex = 5 and groupindex = 0 and itemid = 'id_2038'
        or blockindex = 5 and groupindex = 0 and itemid = 'id_2041'
        or blockindex = 5 and groupindex = 0 and itemid = 'id_2042'
        or blockindex = 5 and groupindex = 0 and itemid = 'id_2045'
        or blockindex = 6 and groupindex = 0 and itemid = 'id_2055'
        or blockindex = 6 and groupindex = 0 and itemid = 'id_2056'
        or blockindex = 6 and groupindex = 0 and itemid = 'id_2059'
        or blockindex = 6 and groupindex = 0 and itemid = 'id_2060'
        or blockindex = 6 and groupindex = 0 and itemid = 'id_2063'
        or blockindex = 7 and groupindex = 0 and itemid = 'id_2064'
        or blockindex = 7 and groupindex = 0 and itemid = 'id_2065'
        or blockindex = 7 and groupindex = 0 and itemid = 'id_2068'
        or blockindex = 7 and groupindex = 0 and itemid = 'id_2069'
        or blockindex = 7 and groupindex = 0 and itemid = 'id_2072'
        or blockindex = 8 and groupindex = 0 and itemid = 'id_2073'
        or blockindex = 8 and groupindex = 0 and itemid = 'id_2074'
        or blockindex = 8 and groupindex = 0 and itemid = 'id_2077'
        or blockindex = 8 and groupindex = 0 and itemid = 'id_2078'
        or blockindex = 8 and groupindex = 0 and itemid = 'id_2079'
        or blockindex = 9 and groupindex = 0 and itemid = 'id_2080'
        or blockindex = 9 and groupindex = 0 and itemid = 'id_2081'
        or blockindex = 9 and groupindex = 0 and itemid = 'id_2084'
        or blockindex = 9 and groupindex = 0 and itemid = 'id_2085'
        or blockindex = 9 and groupindex = 0 and itemid = 'id_2088'
        or blockindex = 10 and groupindex = 0 and itemid = 'id_2089'
        or blockindex = 10 and groupindex = 0 and itemid = 'id_2090'
        or blockindex = 10 and groupindex = 0 and itemid = 'id_2093'
        or blockindex = 10 and groupindex = 0 and itemid = 'id_2094'
        or blockindex = 10 and groupindex = 0 and itemid = 'id_2097'
        or blockindex = 11 and groupindex = 0 and itemid = 'id_2098'
        or blockindex = 11 and groupindex = 0 and itemid = 'id_2534'
        or blockindex = 11 and groupindex = 0 and itemid = 'id_2102'
        or blockindex = 11 and groupindex = 0 and itemid = 'id_2103'
        or blockindex = 11 and groupindex = 0 and itemid = 'id_2106'
        or blockindex = 12 and groupindex = 0 and itemid = 'id_2132'
        or blockindex = 12 and groupindex = 0 and itemid = 'id_2534'
        or blockindex = 12 and groupindex = 0 and itemid = 'id_2102'
        or blockindex = 12 and groupindex = 0 and itemid = 'id_2103'
        or blockindex = 12 and groupindex = 0 and itemid = 'id_2106'
        or blockindex = 13 and groupindex = 0 and itemid = 'id_2172'
        or blockindex = 13 and groupindex = 0 and itemid = 'id_2173'
        or blockindex = 13 and groupindex = 0 and itemid = 'id_2176'
        or blockindex = 13 and groupindex = 0 and itemid = 'id_2177'
        or blockindex = 13 and groupindex = 0 and itemid = 'id_2180'
        or blockindex = 13 and groupindex = 0 and itemid = 'id_2181'
        or blockindex = 13 and groupindex = 0 and itemid = 'id_2182'
        or blockindex = 14 and groupindex = 0 and itemid = 'id_2213'
        or blockindex = 14 and groupindex = 0 and itemid = 'id_2536'
        or blockindex = 14 and groupindex = 0 and itemid = 'id_2215'
        or blockindex = 14 and groupindex = 0 and itemid = 'id_2216'
        or blockindex = 14 and groupindex = 0 and itemid = 'id_2219'
        or blockindex = 15 and groupindex = 0 and itemid = 'id_2520'
        or blockindex = 15 and groupindex = 0 and itemid = 'id_2462'
        or blockindex = 15 and groupindex = 0 and itemid = 'id_2521'" then
        {
            src -> tgt.resource = create('Observation') as observation then TransformObservationIHC(src, observation);
        };
    };
}

group CreateTransformServiceRequestIHC(source src: CTS_Transport, target tgt: BackboneElement)
{
    src.operations as operations, operations.data as data then
    {
        data.values as values where "blockindex = 15 and groupindex = 0 and itemid = 'id_2520'
        or blockindex = 15 and groupindex = 0 and itemid = 'id_2462'
        or blockindex = 15 and groupindex = 0 and itemid = 'id_2521'" then
        {
            src -> tgt.resource = create('ServiceRequest') as serviceRequest then TransformServiceRequestIHC(src, serviceRequest);
        };
    };
}

/* ------------------------------ EpisodeOfCare ---------------------------- */
group TransformEpisodeOfCareIHC(source src: CTS_Transport, target tgt: EpisodeOfCare)
{
    src -> tgt.id = uuid();
    src -> tgt.meta as meta collate, meta.profile = 'http://uk-koeln.de/fhir/StructureDefinition/EpisodeOfCare/nNGM';

    src.patid as patid -> tgt.subject = create('Reference') as subject, subject.reference = evaluate(patid, '\'Patient/\' + $this');

    src.operations as operations, operations.data as data then
    {
        src -> tgt.status = cast('acrive', 'FHIR.code');
        src -> tgt.patient = create('Reference') as subject, subject.reference = evaluate(patid, '\'Patient/\' + $this');

        //Untersuchungsid
        data.values as values where "blockindex = 1 and groupindex = 0 and itemid = 'assessment_id'" then
        {
            values.value as value ->  tgt.identifier = create('Identifier') as biopsie, biopsie.system = 'http://uk-koeln.de/fhir/NamingSystem/nNGM/fallnummer', biopsie.value = value;
        };
    };
}

/* ------------------------------ Organization ---------------------------- */
group TransformOrganizationIHC(source src: CTS_Transport, target tgt: Organization)
{
    src -> tgt.id = uuid();
    src -> tgt.meta as meta collate, meta.profile = 'http://uk-koeln.de/fhir/StructureDefinition/Organization/clinical-site';


    src.operations as operations, operations.data as data then
    {
        //Name
        data.values as values where "blockindex = 2 and groupindex = 0 and itemid = 'id_2435'" then
        {
            values.value as value ->  tgt.name = value;
        };

        //Type
        data.values as values where "blockindex = 2 and groupindex = 0 and itemid = 'id_2613'" then
        {
            values.value as value ->  tgt.type as type, type.text = value;
        };
    };
}

/* ------------------------------ ServiceRequest ---------------------------- */
group TransformServiceRequestIHC(source src: CTS_Transport, target tgt: ServiceRequest)
{
    src -> tgt.id = uuid();
    src -> tgt.meta as meta collate, meta.profile = 'http://uk-koeln.de/fhir/StructureDefinition/ServiceRequest/nNGM/testung';


    src.operations as operations, operations.data as data then
    {

        src -> tgt.intent = cast(proposal, 'FHIR.code');

        //src -> tgt.code = not given

        //Status
        data.values as values where "blockindex = 15 and groupindex = 0 and itemid = 'id_2520'" then
        {
            values.value as value ->  tgt.status = value;
        };

        //Category
        data.values as values where "blockindex = 15 and groupindex = 0 and itemid = 'id_2462'" then
        {
            values.value as value ->  tgt.category = value; //cc('', );
        };

        //occurrenceDateTime
        data.values as values where "blockindex = 15 and groupindex = 0 and itemid = 'id_2521'" then
        {
            values.value as value ->  tgt.occurrenceDateTime = dateOp(value, 'dateTime');
        };
    };
}
